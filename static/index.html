<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nyx Light â€” RaÄunovoÄ‘a</title>
<style>
:root{--bg:#0f1117;--bg2:#1a1d27;--bg3:#242833;--accent:#6366f1;--accent2:#818cf8;
--green:#22c55e;--red:#ef4444;--yellow:#eab308;--text:#e2e8f0;--text2:#94a3b8;
--border:#2d3348;--radius:10px;--shadow:0 4px 24px rgba(0,0,0,.4)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
.login-screen{display:flex;align-items:center;justify-content:center;height:100vh;background:linear-gradient(135deg,#0f1117 0%,#1e1b4b 100%)}
.login-box{background:var(--bg2);padding:40px;border-radius:16px;width:380px;box-shadow:var(--shadow)}
.login-box h1{font-size:24px;margin-bottom:8px;text-align:center}
.login-box .subtitle{color:var(--text2);text-align:center;margin-bottom:28px;font-size:14px}
.login-box input{width:100%;padding:12px 16px;margin-bottom:14px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:14px;outline:none}
.login-box input:focus{border-color:var(--accent)}
.login-box button{width:100%;padding:12px;background:var(--accent);color:white;border:none;border-radius:var(--radius);font-size:15px;cursor:pointer;font-weight:600}
.login-box button:hover{background:var(--accent2)}
.login-error{color:var(--red);font-size:13px;text-align:center;margin-top:10px;display:none}
.app{display:none;height:100vh;grid-template-columns:240px 1fr;grid-template-rows:56px 1fr}
.app.active{display:grid}
.topbar{grid-column:1/-1;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px}
.topbar .logo{font-weight:700;font-size:16px;display:flex;align-items:center;gap:10px}
.topbar .logo span{font-size:22px}
.topbar .user-info{display:flex;align-items:center;gap:12px;font-size:14px}
.topbar .user-info .role{background:var(--accent);padding:2px 10px;border-radius:20px;font-size:12px;font-weight:600}
.topbar .user-info .logout{background:none;border:1px solid var(--border);color:var(--text2);padding:6px 14px;border-radius:var(--radius);cursor:pointer;font-size:13px}
.sidebar{background:var(--bg2);border-right:1px solid var(--border);padding:12px;overflow-y:auto}
.sidebar .nav-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:var(--radius);cursor:pointer;color:var(--text2);font-size:14px;margin-bottom:4px;transition:.15s}
.sidebar .nav-item:hover,.sidebar .nav-item.active{background:var(--bg3);color:var(--text)}
.sidebar .nav-item.active{border-left:3px solid var(--accent);color:var(--accent2)}
.sidebar .nav-item .badge{margin-left:auto;background:var(--red);color:white;font-size:11px;padding:2px 8px;border-radius:20px;font-weight:700}
.sidebar .section-title{font-size:11px;text-transform:uppercase;color:var(--text2);padding:16px 14px 6px;letter-spacing:1px}
.main{overflow:hidden;display:flex;flex-direction:column}
.page{display:none;flex:1;overflow-y:auto;padding:20px}
.page.active{display:flex;flex-direction:column}
/* Chat */
.chat-page{display:none;flex:1;flex-direction:column}
.chat-page.active{display:flex}
.chat-messages{flex:1;overflow-y:auto;padding:20px}
.chat-msg{display:flex;gap:12px;margin-bottom:16px;max-width:800px}
.chat-msg.user{flex-direction:row-reverse;margin-left:auto}
.chat-msg .avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.chat-msg.assistant .avatar{background:var(--accent);color:white}
.chat-msg.user .avatar{background:var(--green);color:white}
.chat-msg .bubble{background:var(--bg2);padding:12px 16px;border-radius:12px;line-height:1.6;font-size:14px;border:1px solid var(--border);max-width:640px;white-space:pre-wrap;word-wrap:break-word}
.chat-msg.user .bubble{background:var(--bg3)}
.chat-input-area{padding:12px 20px;border-top:1px solid var(--border);background:var(--bg2);display:flex;gap:10px;align-items:flex-end}
.chat-input-area textarea{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:12px;color:var(--text);font-size:14px;resize:none;min-height:44px;max-height:120px;font-family:inherit;outline:none}
.chat-input-area textarea:focus{border-color:var(--accent)}
.chat-input-area button{background:var(--accent);color:white;border:none;padding:12px 20px;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:14px;white-space:nowrap}
.chat-input-area button:disabled{opacity:.5;cursor:not-allowed}
.chat-client-select{padding:8px 20px;background:var(--bg);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-size:13px}
.chat-client-select select{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-size:13px}
/* Tables */
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 14px;background:var(--bg3);color:var(--text2);font-weight:600;border-bottom:1px solid var(--border);position:sticky;top:0}
td{padding:10px 14px;border-bottom:1px solid var(--border)}
tr:hover{background:var(--bg3)}
.status-badge{padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600}
.status-pending{background:#854d0e40;color:var(--yellow)}
.status-approved{background:#16653240;color:var(--green)}
.status-rejected{background:#7f1d1d40;color:var(--red)}
/* Action buttons in tables */
.btn-sm{padding:5px 12px;border-radius:6px;font-size:12px;cursor:pointer;border:none;font-weight:600}
.btn-approve{background:var(--green);color:white}
.btn-reject{background:var(--red);color:white}
.btn-correct{background:var(--yellow);color:#000}
.btn-export{background:var(--accent);color:white}
/* Cards */
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-bottom:24px}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.card .card-value{font-size:28px;font-weight:700;margin:8px 0 4px}
.card .card-label{font-size:13px;color:var(--text2)}
.card .card-icon{font-size:24px}
/* Page headers */
.page-header{margin-bottom:20px}
.page-header h2{font-size:20px;margin-bottom:4px}
.page-header p{color:var(--text2);font-size:14px}
/* Toolbar */
.toolbar{display:flex;gap:10px;margin-bottom:16px;align-items:center;flex-wrap:wrap}
.toolbar select,.toolbar input{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:var(--radius);font-size:13px}
.toolbar button{background:var(--accent);color:white;border:none;padding:8px 16px;border-radius:var(--radius);cursor:pointer;font-size:13px;font-weight:600}
/* Modal */
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:28px;width:480px;max-height:80vh;overflow-y:auto}
.modal h3{margin-bottom:16px}
.modal textarea,.modal input,.modal select{width:100%;padding:10px;margin-bottom:12px;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:var(--radius);font-size:14px;font-family:inherit}
.modal .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
.modal .modal-actions button{padding:10px 20px;border-radius:var(--radius);font-weight:600;cursor:pointer;border:none;font-size:14px}
/* Toast */
.toast{position:fixed;top:70px;right:20px;padding:14px 20px;border-radius:var(--radius);font-size:14px;z-index:200;animation:slideIn .3s;box-shadow:var(--shadow)}
.toast.success{background:#16a34a;color:white}
.toast.error{background:var(--red);color:white}
.toast.info{background:var(--accent);color:white}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
/* Responsive */
@media(max-width:768px){.app.active{grid-template-columns:1fr}.sidebar{display:none}}
/* Upload area */
.upload-area{border:2px dashed var(--border);border-radius:var(--radius);padding:40px;text-align:center;cursor:pointer;color:var(--text2);transition:.2s}
.upload-area:hover{border-color:var(--accent);color:var(--text)}
.upload-area.dragover{border-color:var(--accent);background:rgba(99,102,241,.1)}
/* Typing indicator */
.typing{display:none;padding:8px 16px;color:var(--text2);font-size:13px}
.typing.active{display:block}
.typing .dots span{animation:blink 1.4s infinite;font-size:18px}
.typing .dots span:nth-child(2){animation-delay:.2s}
.typing .dots span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,100%{opacity:.2}50%{opacity:1}}
/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
<div class="login-box">
  <h1><span>ğŸŒ™</span> Nyx Light</h1>
  <p class="subtitle">RaÄunovoÄ‘a â€” Privatni AI sustav</p>
  <input type="text" id="loginUser" placeholder="KorisniÄko ime" autocomplete="username" autofocus>
  <input type="password" id="loginPass" placeholder="Lozinka" autocomplete="current-password">
  <button onclick="doLogin()">Prijava</button>
  <p class="login-error" id="loginError"></p>
  <p style="text-align:center;margin-top:16px;font-size:12px;color:var(--text2)">admin / admin123 (demo)</p>
</div>
</div>

<!-- APP -->
<div class="app" id="app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="logo"><span>ğŸŒ™</span> Nyx Light â€” RaÄunovoÄ‘a</div>
    <div class="user-info">
      <span id="userName"></span>
      <span class="role" id="userRole"></span>
      <button class="logout" onclick="doLogout()">Odjava</button>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="section-title">Rad</div>
    <div class="nav-item active" data-page="chat" onclick="showPage('chat')">ğŸ’¬ Chat</div>
    <div class="nav-item" data-page="pending" onclick="showPage('pending')">ğŸ“‹ Odobrenja <span class="badge" id="pendingBadge" style="display:none">0</span></div>
    <div class="nav-item" data-page="bookings" onclick="showPage('bookings')">ğŸ“’ KnjiÅ¾enja</div>
    <div class="nav-item" data-page="upload" onclick="showPage('upload')">ğŸ“¤ Upload</div>

    <div class="section-title">IzvjeÅ¡taji</div>
    <div class="nav-item" data-page="dashboard" onclick="showPage('dashboard')">ğŸ“Š Dashboard</div>
    <div class="nav-item" data-page="deadlines" onclick="showPage('deadlines')">ğŸ“… Rokovi</div>
    <div class="nav-item" data-page="clients" onclick="showPage('clients')">ğŸ¢ Klijenti</div>

    <div class="section-title">Sustav</div>
    <div class="nav-item" data-page="export" onclick="showPage('export')">ğŸ’¾ Export</div>
    <div class="nav-item" data-page="system" onclick="showPage('system')">âš™ï¸ Status</div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main">
    <!-- CHAT PAGE -->
    <div class="chat-page active" id="page-chat">
      <div class="chat-client-select">
        <span>Klijent:</span>
        <select id="chatClient" onchange="switchChatClient()">
          <option value="">OpÄ‡enito (bez klijenta)</option>
        </select>
        <button onclick="clearChat()" style="margin-left:auto;background:var(--bg3);color:var(--text2);border:1px solid var(--border);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">ObriÅ¡i chat</button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-msg assistant">
          <div class="avatar">N</div>
          <div class="bubble">Pozdrav! Ja sam Nyx Light â€” RaÄunovoÄ‘a. Postavite mi pitanje o kontiranju, porezima, zakonima ili mi poÅ¡aljite dokument za obradu. ğŸŒ™</div>
        </div>
      </div>
      <div class="typing" id="chatTyping">Nyx razmiÅ¡lja <span class="dots"><span>.</span><span>.</span><span>.</span></span></div>
      <div class="chat-input-area">
        <textarea id="chatInput" placeholder="UpiÅ¡ite poruku..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
        <button id="chatSend" onclick="sendChat()">PoÅ¡alji</button>
      </div>
    </div>

    <!-- PENDING PAGE -->
    <div class="page" id="page-pending">
      <div class="page-header">
        <h2>ğŸ“‹ KnjiÅ¾enja za odobrenje</h2>
        <p>Human-in-the-Loop: svako knjiÅ¾enje mora biti odobreno</p>
      </div>
      <div class="toolbar">
        <select id="pendingFilter" onchange="loadPending()">
          <option value="">Svi klijenti</option>
        </select>
        <button onclick="loadPending()">ğŸ”„ OsvjeÅ¾i</button>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>Datum</th><th>Klijent</th><th>Opis</th><th>Duguje</th><th>PotraÅ¾uje</th><th>Iznos</th><th>Conf.</th><th>Akcije</th></tr></thead>
          <tbody id="pendingBody"></tbody>
        </table>
      </div>
    </div>

    <!-- BOOKINGS PAGE -->
    <div class="page" id="page-bookings">
      <div class="page-header">
        <h2>ğŸ“’ Sva knjiÅ¾enja</h2>
        <p>Pregled svih obraÄ‘enih knjiÅ¾enja</p>
      </div>
      <div class="toolbar">
        <select id="bookingsFilter"><option value="">Svi statusi</option><option value="approved">Odobreno</option><option value="pending">Na Äekanju</option><option value="rejected">Odbijeno</option></select>
        <select id="bookingsClient"><option value="">Svi klijenti</option></select>
        <button onclick="loadBookings()">ğŸ”„ OsvjeÅ¾i</button>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>ID</th><th>Datum</th><th>Klijent</th><th>Opis</th><th>D/P</th><th>Iznos</th><th>Status</th><th>Odobrio</th></tr></thead>
          <tbody id="bookingsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- UPLOAD PAGE -->
    <div class="page" id="page-upload">
      <div class="page-header">
        <h2>ğŸ“¤ Upload dokumenata</h2>
        <p>PDF, slike, MT940, XML â€” sustav automatski prepoznaje tip</p>
      </div>
      <div class="toolbar">
        <select id="uploadClient"><option value="">Odaberi klijenta</option></select>
      </div>
      <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()"
           ondragover="event.preventDefault();this.classList.add('dragover')"
           ondragleave="this.classList.remove('dragover')"
           ondrop="event.preventDefault();this.classList.remove('dragover');handleDrop(event)">
        <p style="font-size:40px;margin-bottom:12px">ğŸ“„</p>
        <p>Kliknite ili povucite datoteke ovdje</p>
        <p style="font-size:12px;margin-top:8px">PDF, JPEG, PNG, MT940, CSV, XML</p>
        <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.mt940,.csv,.xml,.xlsx" style="display:none" onchange="handleFiles(this.files)">
      </div>
      <div id="uploadResults" style="margin-top:20px"></div>
    </div>

    <!-- DASHBOARD PAGE -->
    <div class="page" id="page-dashboard">
      <div class="page-header">
        <h2>ğŸ“Š Dashboard</h2>
        <p>Pregled sustava u realnom vremenu</p>
      </div>
      <div class="cards" id="dashCards"></div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>Modul</th><th>Status</th><th>Procesiranih</th><th>UspjeÅ¡nost</th></tr></thead>
          <tbody id="dashModules"></tbody>
        </table>
      </div>
    </div>

    <!-- DEADLINES PAGE -->
    <div class="page" id="page-deadlines">
      <div class="page-header">
        <h2>ğŸ“… NadolazeÄ‡i rokovi</h2>
        <p>Porezni rokovi, predaje, obveze</p>
      </div>
      <div id="deadlinesList"></div>
    </div>

    <!-- CLIENTS PAGE -->
    <div class="page" id="page-clients">
      <div class="page-header">
        <h2>ğŸ¢ Klijenti</h2>
        <p>Upravljanje klijentima ureda</p>
      </div>
      <div class="toolbar">
        <button onclick="showAddClient()">+ Novi klijent</button>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>Naziv</th><th>OIB</th><th>ERP</th><th>KnjiÅ¾enja</th><th>Status</th></tr></thead>
          <tbody id="clientsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- EXPORT PAGE -->
    <div class="page" id="page-export">
      <div class="page-header">
        <h2>ğŸ’¾ Export u ERP</h2>
        <p>Izvoz odobrenih knjiÅ¾enja u CPP ili Synesis</p>
      </div>
      <div class="toolbar">
        <select id="exportClient"><option value="">Odaberi klijenta</option></select>
        <select id="exportFormat"><option value="cpp_xml">CPP XML</option><option value="synesis_csv">Synesis CSV</option><option value="json">JSON</option><option value="xlsx">Excel</option></select>
        <button class="btn-export" onclick="doExport()">ğŸ’¾ Exportiraj</button>
      </div>
      <div id="exportResults"></div>
    </div>

    <!-- SYSTEM PAGE -->
    <div class="page" id="page-system">
      <div class="page-header">
        <h2>âš™ï¸ Status sustava</h2>
        <p>Hardver, AI modeli, memorija, baza znanja</p>
      </div>
      <div class="cards" id="sysCards"></div>
      <pre id="sysDetails" style="background:var(--bg3);padding:16px;border-radius:var(--radius);font-size:12px;overflow-x:auto;max-height:500px;overflow-y:auto"></pre>
    </div>
  </div>
</div>

<!-- CORRECT MODAL -->
<div class="modal-overlay" id="correctModal">
  <div class="modal">
    <h3>âœï¸ Ispravi knjiÅ¾enje</h3>
    <input type="hidden" id="correctBookingId">
    <label style="font-size:13px;color:var(--text2)">Konto duguje:</label>
    <input id="correctDuguje" placeholder="npr. 4010">
    <label style="font-size:13px;color:var(--text2)">Konto potraÅ¾uje:</label>
    <input id="correctPotrazuje" placeholder="npr. 2200">
    <label style="font-size:13px;color:var(--text2)">Razlog ispravka:</label>
    <textarea id="correctReason" placeholder="Objasni ispravak..." rows="3"></textarea>
    <div class="modal-actions">
      <button style="background:var(--bg3);color:var(--text2)" onclick="closeModal('correctModal')">Odustani</button>
      <button style="background:var(--green);color:white" onclick="submitCorrection()">Spremi ispravak</button>
    </div>
  </div>
</div>

<!-- ADD CLIENT MODAL -->
<div class="modal-overlay" id="clientModal">
  <div class="modal">
    <h3>ğŸ¢ Novi klijent</h3>
    <input id="clientName" placeholder="Naziv tvrtke">
    <input id="clientOIB" placeholder="OIB (11 znamenki)" maxlength="11">
    <select id="clientERP"><option value="CPP">CPP</option><option value="Synesis">Synesis</option></select>
    <div class="modal-actions">
      <button style="background:var(--bg3);color:var(--text2)" onclick="closeModal('clientModal')">Odustani</button>
      <button style="background:var(--accent);color:white" onclick="submitClient()">Dodaj</button>
    </div>
  </div>
</div>

<script>
const API='/api';
let token='',currentUser=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value;
  const err=document.getElementById('loginError');
  if(!u||!p){err.textContent='Unesite korisniÄko ime i lozinku';err.style.display='block';return}
  try{
    const r=await fetch(API+'/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
    const d=await r.json();
    if(!r.ok){err.textContent=d.detail||'GreÅ¡ka pri prijavi';err.style.display='block';return}
    token=d.token;currentUser=d.user;
    localStorage.setItem('nyx_token',token);
    localStorage.setItem('nyx_user',JSON.stringify(currentUser));
    showApp();
  }catch(e){err.textContent='Server nije dostupan';err.style.display='block'}
}
function doLogout(){token='';currentUser=null;localStorage.removeItem('nyx_token');localStorage.removeItem('nyx_user');
  document.getElementById('app').classList.remove('active');document.getElementById('loginScreen').style.display='flex'}
function showApp(){
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('app').classList.add('active');
  document.getElementById('userName').textContent=currentUser.display_name||currentUser.username;
  document.getElementById('userRole').textContent=currentUser.role;
  loadClients();loadPending();loadDashboard();loadDeadlines();
}
function authHeaders(){return{'Authorization':'Bearer '+token,'Content-Type':'application/json'}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name){
  document.querySelectorAll('.page,.chat-page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const el=document.getElementById('page-'+name);
  if(el)el.classList.add('active');
  document.querySelector(`[data-page="${name}"]`)?.classList.add('active');
  if(name==='pending')loadPending();
  if(name==='bookings')loadBookings();
  if(name==='dashboard')loadDashboard();
  if(name==='system')loadSystemStatus();
  if(name==='deadlines')loadDeadlines();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendChat(){
  const input=document.getElementById('chatInput');
  const msg=input.value.trim();if(!msg)return;
  input.value='';input.style.height='44px';
  addChatMsg('user',msg);
  document.getElementById('chatTyping').classList.add('active');
  document.getElementById('chatSend').disabled=true;
  try{
    const r=await fetch(API+'/chat',{method:'POST',headers:authHeaders(),
      body:JSON.stringify({message:msg,client_id:document.getElementById('chatClient').value})});
    const d=await r.json();
    addChatMsg('assistant',d.content||d.detail||'GreÅ¡ka');
  }catch(e){addChatMsg('assistant','âš ï¸ Server nije dostupan: '+e.message)}
  document.getElementById('chatTyping').classList.remove('active');
  document.getElementById('chatSend').disabled=false;
}
function addChatMsg(role,text){
  const div=document.createElement('div');div.className='chat-msg '+role;
  div.innerHTML=`<div class="avatar">${role==='user'?'ğŸ‘¤':'N'}</div><div class="bubble">${escHtml(text)}</div>`;
  const c=document.getElementById('chatMessages');c.appendChild(div);c.scrollTop=c.scrollHeight;
}
function clearChat(){document.getElementById('chatMessages').innerHTML='';addChatMsg('assistant','Chat obrisan. Kako vam mogu pomoÄ‡i?')}
function switchChatClient(){}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PENDING APPROVALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPending(){
  try{
    const cid=document.getElementById('pendingFilter')?.value||'';
    const r=await fetch(API+'/pending?client_id='+cid,{headers:authHeaders()});
    const data=await r.json();const items=data.items||data||[];
    const badge=document.getElementById('pendingBadge');
    badge.textContent=items.length;badge.style.display=items.length?'inline':'none';
    const tb=document.getElementById('pendingBody');tb.innerHTML='';
    items.forEach(b=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${b.datum_dokumenta||b.created_at||''}</td><td>${b.client_id}</td>
        <td>${escHtml(b.opis||'')}</td><td>${b.konto_duguje||''}</td><td>${b.konto_potrazuje||''}</td>
        <td style="text-align:right;font-weight:600">${fmt(b.iznos)}</td>
        <td><span style="color:${b.confidence>=0.9?'var(--green)':b.confidence>=0.7?'var(--yellow)':'var(--red)'}">${(b.confidence*100).toFixed(0)}%</span></td>
        <td>
          <button class="btn-sm btn-approve" onclick="approveBooking('${b.id}')">âœ“</button>
          <button class="btn-sm btn-reject" onclick="rejectBooking('${b.id}')">âœ—</button>
          <button class="btn-sm btn-correct" onclick="showCorrect('${b.id}','${b.konto_duguje||''}','${b.konto_potrazuje||''}')">âœï¸</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){console.error('loadPending',e)}
}
async function approveBooking(id){
  await fetch(API+'/approve/'+id,{method:'POST',headers:authHeaders()});toast('KnjiÅ¾enje odobreno','success');loadPending();
}
async function rejectBooking(id){
  if(!confirm('Odbiti knjiÅ¾enje?'))return;
  await fetch(API+'/reject/'+id,{method:'POST',headers:authHeaders(),body:JSON.stringify({reason:'Odbijeno od korisnika'})});toast('KnjiÅ¾enje odbijeno','info');loadPending();
}
function showCorrect(id,d,p){
  document.getElementById('correctBookingId').value=id;
  document.getElementById('correctDuguje').value=d;
  document.getElementById('correctPotrazuje').value=p;
  document.getElementById('correctModal').classList.add('active');
}
async function submitCorrection(){
  const id=document.getElementById('correctBookingId').value;
  const body={konto_duguje:document.getElementById('correctDuguje').value,
    konto_potrazuje:document.getElementById('correctPotrazuje').value,
    reason:document.getElementById('correctReason').value};
  await fetch(API+'/correct/'+id,{method:'POST',headers:authHeaders(),body:JSON.stringify(body)});
  closeModal('correctModal');toast('Ispravak spremljen','success');loadPending();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOKINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadBookings(){
  try{
    const status=document.getElementById('bookingsFilter').value;
    const cid=document.getElementById('bookingsClient').value;
    const r=await fetch(API+`/bookings?status=${status}&client_id=${cid}`,{headers:authHeaders()});
    const data=await r.json();const items=data.items||data||[];
    const tb=document.getElementById('bookingsBody');tb.innerHTML='';
    items.forEach(b=>{
      const tr=document.createElement('tr');
      const sc=b.status==='approved'?'status-approved':b.status==='pending'?'status-pending':'status-rejected';
      tr.innerHTML=`<td style="font-size:11px;color:var(--text2)">${(b.id||'').substring(0,12)}</td>
        <td>${b.datum_dokumenta||b.created_at||''}</td><td>${b.client_id}</td>
        <td>${escHtml(b.opis||'')}</td><td>${b.konto_duguje||''}/${b.konto_potrazuje||''}</td>
        <td style="text-align:right">${fmt(b.iznos)}</td>
        <td><span class="status-badge ${sc}">${b.status}</span></td>
        <td>${b.approved_by||''}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){console.error('loadBookings',e)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadClients(){
  try{
    const r=await fetch(API+'/clients',{headers:authHeaders()});
    const data=await r.json();const items=data.items||data||[];
    const tb=document.getElementById('clientsBody');tb.innerHTML='';
    // Populate all client selectors
    ['chatClient','pendingFilter','bookingsClient','uploadClient','exportClient'].forEach(sid=>{
      const sel=document.getElementById(sid);if(!sel)return;
      const first=sel.options[0];sel.innerHTML='';sel.appendChild(first);
      items.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;sel.appendChild(o)});
    });
    items.forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><strong>${escHtml(c.name)}</strong></td><td>${c.oib||''}</td>
        <td>${c.erp_system||'CPP'}</td><td>${c.bookings_count||0}</td>
        <td><span class="status-badge ${c.active?'status-approved':'status-rejected'}">${c.active?'Aktivan':'Neaktivan'}</span></td>`;
      tb.appendChild(tr);
    });
  }catch(e){console.error('loadClients',e)}
}
function showAddClient(){document.getElementById('clientModal').classList.add('active')}
async function submitClient(){
  const body={name:document.getElementById('clientName').value,
    oib:document.getElementById('clientOIB').value,
    erp_system:document.getElementById('clientERP').value};
  await fetch(API+'/clients',{method:'POST',headers:authHeaders(),body:JSON.stringify(body)});
  closeModal('clientModal');toast('Klijent dodan','success');loadClients();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard(){
  try{
    const r=await fetch(API+'/dashboard',{headers:authHeaders()});const d=await r.json();
    const cards=document.getElementById('dashCards');
    cards.innerHTML=`
      <div class="card"><div class="card-icon">ğŸ“‹</div><div class="card-value">${d.pending||0}</div><div class="card-label">Na Äekanju</div></div>
      <div class="card"><div class="card-icon">âœ…</div><div class="card-value">${d.approved||0}</div><div class="card-label">Odobreno</div></div>
      <div class="card"><div class="card-icon">ğŸ“’</div><div class="card-value">${d.total_bookings||0}</div><div class="card-label">Ukupno knjiÅ¾enja</div></div>
      <div class="card"><div class="card-icon">ğŸ¢</div><div class="card-value">${d.clients||0}</div><div class="card-label">Klijenata</div></div>
      <div class="card"><div class="card-icon">âœï¸</div><div class="card-value">${d.corrections||0}</div><div class="card-label">Ispravaka</div></div>
      <div class="card"><div class="card-icon">ğŸ‘¥</div><div class="card-value">${d.active_sessions||0}</div><div class="card-label">Aktivnih sesija</div></div>`;
  }catch(e){console.error('dashboard',e)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEADLINES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDeadlines(){
  try{
    const r=await fetch(API+'/deadlines',{headers:authHeaders()});const d=await r.json();
    const items=d.items||d||[];const el=document.getElementById('deadlinesList');el.innerHTML='';
    if(!items.length){el.innerHTML='<p style="color:var(--text2)">Nema nadolazeÄ‡ih rokova.</p>';return}
    items.forEach(dl=>{
      const days=dl.days_remaining!=null?dl.days_remaining:'?';
      const color=days<=3?'var(--red)':days<=7?'var(--yellow)':'var(--green)';
      const div=document.createElement('div');
      div.style.cssText=`background:var(--bg2);border:1px solid var(--border);border-left:4px solid ${color};border-radius:var(--radius);padding:16px;margin-bottom:10px`;
      div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${escHtml(dl.name||dl.title||'')}</strong><br><span style="font-size:13px;color:var(--text2)">${escHtml(dl.description||'')}</span></div>
        <div style="text-align:right"><div style="font-size:22px;font-weight:700;color:${color}">${days}d</div><div style="font-size:12px;color:var(--text2)">${dl.due_date||''}</div></div></div>`;
      el.appendChild(div);
    });
  }catch(e){console.error('deadlines',e)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYSTEM STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSystemStatus(){
  try{
    const r=await fetch(API+'/system/status',{headers:authHeaders()});const d=await r.json();
    const cards=document.getElementById('sysCards');
    cards.innerHTML=`
      <div class="card"><div class="card-icon">ğŸ¤–</div><div class="card-value" style="font-size:14px">${d.model||'N/A'}</div><div class="card-label">AI Model</div></div>
      <div class="card"><div class="card-icon">ğŸ§ </div><div class="card-value">${d.memory_used_gb||'?'} GB</div><div class="card-label">Memorija</div></div>
      <div class="card"><div class="card-icon">ğŸ”§</div><div class="card-value">${d.vllm_status||'?'}</div><div class="card-label">vLLM Status</div></div>
      <div class="card"><div class="card-icon">ğŸ“Š</div><div class="card-value">${d.total_tokens||0}</div><div class="card-label">Ukupno tokena</div></div>`;
    document.getElementById('sysDetails').textContent=JSON.stringify(d,null,2);
  }catch(e){document.getElementById('sysDetails').textContent='Server nedostupan: '+e.message}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doExport(){
  const cid=document.getElementById('exportClient').value;
  const fmt2=document.getElementById('exportFormat').value;
  if(!cid){toast('Odaberite klijenta','error');return}
  try{
    const r=await fetch(API+'/export',{method:'POST',headers:authHeaders(),
      body:JSON.stringify({client_id:cid,format:fmt2})});
    const d=await r.json();
    document.getElementById('exportResults').innerHTML=`<div class="card" style="margin-top:16px">
      <p>âœ… Eksportirano <strong>${d.count||0}</strong> knjiÅ¾enja</p>
      <p style="font-size:13px;color:var(--text2);margin-top:8px">Format: ${fmt2} Â· Datoteka: ${d.filename||'N/A'}</p>
      ${d.download_url?`<a href="${d.download_url}" style="color:var(--accent)" download>â¬‡ï¸ Preuzmi</a>`:''}</div>`;
    toast('Export uspjeÅ¡an','success');
  }catch(e){toast('Export greÅ¡ka: '+e.message,'error')}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleDrop(e){handleFiles(e.dataTransfer.files)}
async function handleFiles(files){
  const cid=document.getElementById('uploadClient').value;
  if(!cid){toast('Odaberite klijenta prije uploada','error');return}
  const results=document.getElementById('uploadResults');results.innerHTML='<p>Uploading...</p>';
  for(const f of files){
    const fd=new FormData();fd.append('file',f);fd.append('client_id',cid);
    try{
      const r=await fetch(API+'/upload',{method:'POST',headers:{'Authorization':'Bearer '+token},body:fd});
      const d=await r.json();
      results.innerHTML+=`<div class="card" style="margin-bottom:8px">
        <strong>${escHtml(f.name)}</strong> â€” ${d.status||'processed'}
        <br><span style="font-size:12px;color:var(--text2)">${escHtml(d.details||JSON.stringify(d))}</span></div>`;
    }catch(e){results.innerHTML+=`<div class="card" style="border-color:var(--red)">âŒ ${escHtml(f.name)}: ${e.message}</div>`}
  }
  loadPending();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function fmt(n){return(n||0).toLocaleString('hr-HR',{minimumFractionDigits:2,maximumFractionDigits:2})+' â‚¬'}
function closeModal(id){document.getElementById(id).classList.remove('active')}
function toast(msg,type='info'){
  const t=document.createElement('div');t.className='toast '+type;t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),3500);
}
// Auto-resize textarea
document.getElementById('chatInput')?.addEventListener('input',function(){this.style.height='44px';this.style.height=Math.min(this.scrollHeight,120)+'px'});
// Password enter
document.getElementById('loginPass')?.addEventListener('keydown',function(e){if(e.key==='Enter')doLogin()});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” check stored token
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const t=localStorage.getItem('nyx_token');const u=localStorage.getItem('nyx_user');
  if(t&&u){token=t;try{currentUser=JSON.parse(u);showApp()}catch(e){doLogout()}}
})();
</script>
</body>
</html>
