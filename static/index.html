<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nyx Light â€” RaÄunovoÄ‘a</title>
<style>
:root{--bg:#0f1117;--bg2:#1a1d27;--bg3:#242833;--accent:#6366f1;--accent2:#818cf8;
--green:#22c55e;--red:#ef4444;--yellow:#eab308;--text:#e2e8f0;--text2:#94a3b8;
--border:#2d3348;--radius:10px;--shadow:0 4px 24px rgba(0,0,0,.4)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
.login-screen{display:flex;align-items:center;justify-content:center;height:100vh;background:linear-gradient(135deg,#0f1117 0%,#1e1b4b 100%)}
.login-box{background:var(--bg2);padding:40px;border-radius:16px;width:380px;box-shadow:var(--shadow)}
.login-box h1{font-size:24px;margin-bottom:8px;text-align:center}
.login-box .subtitle{color:var(--text2);text-align:center;margin-bottom:28px;font-size:14px}
.login-box input{width:100%;padding:12px 16px;margin-bottom:14px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:14px;outline:none}
.login-box input:focus{border-color:var(--accent)}
.login-box button{width:100%;padding:12px;background:var(--accent);color:white;border:none;border-radius:var(--radius);font-size:15px;cursor:pointer;font-weight:600}
.login-box button:hover{background:var(--accent2)}
.login-error{color:var(--red);font-size:13px;text-align:center;margin-top:10px;display:none}
.app{display:none;height:100vh;grid-template-columns:240px 1fr;grid-template-rows:56px 1fr}
.app.active{display:grid}
.topbar{grid-column:1/-1;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px}
.topbar .logo{font-weight:700;font-size:16px;display:flex;align-items:center;gap:10px}
.topbar .logo span{font-size:22px}
.topbar .user-info{display:flex;align-items:center;gap:12px;font-size:14px}
.topbar .user-info .role{background:var(--accent);padding:2px 10px;border-radius:20px;font-size:12px;font-weight:600}
.topbar .user-info .logout{background:none;border:1px solid var(--border);color:var(--text2);padding:6px 14px;border-radius:var(--radius);cursor:pointer;font-size:13px}
.sidebar{background:var(--bg2);border-right:1px solid var(--border);padding:12px;overflow-y:auto}
.sidebar .nav-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:var(--radius);cursor:pointer;color:var(--text2);font-size:14px;margin-bottom:4px;transition:.15s}
.sidebar .nav-item:hover,.sidebar .nav-item.active{background:var(--bg3);color:var(--text)}
.sidebar .nav-item.active{border-left:3px solid var(--accent);color:var(--accent2)}
.sidebar .nav-item .badge{margin-left:auto;background:var(--red);color:white;font-size:11px;padding:2px 8px;border-radius:20px;font-weight:700}
.sidebar .section-title{font-size:11px;text-transform:uppercase;color:var(--text2);padding:16px 14px 6px;letter-spacing:1px}
.main{overflow:hidden;display:flex;flex-direction:column}
.page{display:none;flex:1;overflow-y:auto;padding:20px}
.page.active{display:flex;flex-direction:column}
/* Chat */
.chat-page{display:none;flex:1;flex-direction:column}
.chat-page.active{display:flex}
.chat-messages{flex:1;overflow-y:auto;padding:20px}
.chat-msg{display:flex;gap:12px;margin-bottom:16px;max-width:800px}
.chat-msg.user{flex-direction:row-reverse;margin-left:auto}
.chat-msg .avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.chat-msg.assistant .avatar{background:var(--accent);color:white}
.chat-msg.user .avatar{background:var(--green);color:white}
.chat-msg .bubble{background:var(--bg2);padding:12px 16px;border-radius:12px;line-height:1.6;font-size:14px;border:1px solid var(--border);max-width:640px;white-space:pre-wrap;word-wrap:break-word}
.chat-msg.user .bubble{background:var(--bg3)}
.chat-input-area{padding:12px 20px;border-top:1px solid var(--border);background:var(--bg2);display:flex;gap:10px;align-items:flex-end}
.chat-input-area textarea{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:12px;color:var(--text);font-size:14px;resize:none;min-height:44px;max-height:120px;font-family:inherit;outline:none}
.chat-input-area textarea:focus{border-color:var(--accent)}
.chat-input-area button{background:var(--accent);color:white;border:none;padding:12px 20px;border-radius:var(--radius);cursor:pointer;font-weight:600;font-size:14px;white-space:nowrap}
.chat-input-area button:disabled{opacity:.5;cursor:not-allowed}
.chat-client-select{padding:8px 20px;background:var(--bg);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-size:13px}
.chat-client-select select{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-size:13px}
/* Tables */
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 14px;background:var(--bg3);color:var(--text2);font-weight:600;border-bottom:1px solid var(--border);position:sticky;top:0}
td{padding:10px 14px;border-bottom:1px solid var(--border)}
tr:hover{background:var(--bg3)}
.status-badge{padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600}
.status-pending{background:#854d0e40;color:var(--yellow)}
.status-approved{background:#16653240;color:var(--green)}
.status-rejected{background:#7f1d1d40;color:var(--red)}
/* Action buttons in tables */
.btn-sm{padding:5px 12px;border-radius:6px;font-size:12px;cursor:pointer;border:none;font-weight:600}
.btn-approve{background:var(--green);color:white}
.btn-reject{background:var(--red);color:white}
.btn-correct{background:var(--yellow);color:#000}
.btn-export{background:var(--accent);color:white}
/* Cards */
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-bottom:24px}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.card .card-value{font-size:28px;font-weight:700;margin:8px 0 4px}
.card .card-label{font-size:13px;color:var(--text2)}
.card .card-icon{font-size:24px}
/* Page headers */
.page-header{margin-bottom:20px}
.page-header h2{font-size:20px;margin-bottom:4px}
.page-header p{color:var(--text2);font-size:14px}
/* Toolbar */
.toolbar{display:flex;gap:10px;margin-bottom:16px;align-items:center;flex-wrap:wrap}
.toolbar select,.toolbar input{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:var(--radius);font-size:13px}
.toolbar button{background:var(--accent);color:white;border:none;padding:8px 16px;border-radius:var(--radius);cursor:pointer;font-size:13px;font-weight:600}
/* Modal */
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:28px;width:480px;max-height:80vh;overflow-y:auto}
.modal h3{margin-bottom:16px}
.modal textarea,.modal input,.modal select{width:100%;padding:10px;margin-bottom:12px;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:var(--radius);font-size:14px;font-family:inherit}
.modal .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
.modal .modal-actions button{padding:10px 20px;border-radius:var(--radius);font-weight:600;cursor:pointer;border:none;font-size:14px}
/* Toast */
.toast{position:fixed;top:70px;right:20px;padding:14px 20px;border-radius:var(--radius);font-size:14px;z-index:200;animation:slideIn .3s;box-shadow:var(--shadow)}
.toast.success{background:#16a34a;color:white}
.toast.error{background:var(--red);color:white}
.toast.info{background:var(--accent);color:white}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
/* Responsive */
@media(max-width:768px){.app.active{grid-template-columns:1fr}.sidebar{display:none}.sidebar.mobile-open{display:block;position:fixed;top:56px;left:0;bottom:0;width:260px;z-index:50}.hamburger{display:block !important}}
.hamburger{display:none;background:none;border:none;color:var(--text);font-size:22px;cursor:pointer;padding:4px 8px}
/* Light theme */
body.light{--bg:#f8fafc;--bg2:#ffffff;--bg3:#f1f5f9;--text:#1e293b;--text2:#64748b;--border:#e2e8f0;--shadow:0 4px 24px rgba(0,0,0,.08)}
body.light .login-screen{background:linear-gradient(135deg,#f8fafc 0%,#e0e7ff 100%)}
body.light .chat-msg .bubble{border-color:#e2e8f0}
/* Chart container */
.chart-box{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px}
.chart-box canvas{max-height:260px}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:900px){.charts-grid{grid-template-columns:1fr}}
/* Payroll */
.payroll-form{display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:800px}
@media(max-width:600px){.payroll-form{grid-template-columns:1fr}}
.payroll-form label{font-size:13px;color:var(--text2);margin-bottom:4px}
.payroll-form input,.payroll-form select{padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:14px}
.stat-card{background:var(--bg3);padding:16px;border-radius:var(--radius);text-align:center}
.stat-label{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.stat-value{font-size:22px;font-weight:700;color:var(--text)}
.data-table{width:100%;border-collapse:collapse;font-size:13px;margin-top:12px}
.data-table th{background:var(--bg3);padding:8px 12px;text-align:left;color:var(--text2);font-weight:600;border-bottom:2px solid var(--border)}
.data-table td{padding:8px 12px;border-bottom:1px solid var(--border)}
.data-table tr:hover{background:var(--bg3)}
.payroll-result{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-top:20px}
.payroll-result .row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:14px}
.payroll-result .row.total{font-weight:700;font-size:16px;border-bottom:2px solid var(--accent)}
/* Keyboard shortcuts hint */
.kb-hint{position:fixed;bottom:12px;left:260px;font-size:11px;color:var(--text2);opacity:.5}
@media(max-width:768px){.kb-hint{display:none}}
/* Upload area */
.upload-area{border:2px dashed var(--border);border-radius:var(--radius);padding:40px;text-align:center;cursor:pointer;color:var(--text2);transition:.2s}
.upload-area:hover{border-color:var(--accent);color:var(--text)}
.upload-area.dragover{border-color:var(--accent);background:rgba(99,102,241,.1)}
/* Typing indicator */
.typing{display:none;padding:8px 16px;color:var(--text2);font-size:13px}
.typing.active{display:block}
.typing .dots span{animation:blink 1.4s infinite;font-size:18px}
.typing .dots span:nth-child(2){animation-delay:.2s}
.typing .dots span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,100%{opacity:.2}50%{opacity:1}}
/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
<div class="login-box">
  <h1><span>ğŸŒ™</span> Nyx Light</h1>
  <p class="subtitle">RaÄunovoÄ‘a â€” Privatni AI sustav</p>
  <input type="text" id="loginUser" placeholder="KorisniÄko ime" autocomplete="username" autofocus>
  <input type="password" id="loginPass" placeholder="Lozinka" autocomplete="current-password">
  <button onclick="doLogin()">Prijava</button>
  <p class="login-error" id="loginError"></p>
  <p style="text-align:center;margin-top:16px;font-size:12px;color:var(--text2)">admin / admin123 (demo)</p>
</div>
</div>

<!-- APP -->
<div class="app" id="app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="logo"><button class="hamburger" onclick="toggleMobile()">â˜°</button><span>ğŸŒ™</span> Nyx Light â€” RaÄunovoÄ‘a</div>
    <div class="user-info">
      <span id="userName"></span>
      <span class="role" id="userRole"></span>
      <button class="logout" onclick="doLogout()">Odjava</button>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="section-title">Rad</div>
    <div class="nav-item active" data-page="chat" onclick="showPage('chat')">ğŸ’¬ Chat</div>
    <div class="nav-item" data-page="pending" onclick="showPage('pending')">ğŸ“‹ Odobrenja <span class="badge" id="pendingBadge" style="display:none">0</span></div>
    <div class="nav-item" data-page="bookings" onclick="showPage('bookings')">ğŸ“’ KnjiÅ¾enja</div>
    <div class="nav-item" data-page="upload" onclick="showPage('upload')">ğŸ“¤ Upload</div>

    <div class="section-title">Moduli</div>
    <div class="nav-item" data-page="payroll" onclick="showPage('payroll')">ğŸ’° PlaÄ‡e</div>
    <div class="nav-item" data-page="amort" onclick="showPage('amort')">ğŸ­ Amortizacija</div>
    <div class="nav-item" data-page="bank" onclick="showPage('bank')">ğŸ¦ Banka</div>
    <div class="nav-item" data-page="kontiranje" onclick="showPage('kontiranje')">ğŸ“ Kontiranje</div>
    <div class="nav-item" data-page="blagajna" onclick="showPage('blagajna')">ğŸ’µ Blagajna</div>
    <div class="nav-item" data-page="putni" onclick="showPage('putni')">ğŸš— Putni nalozi</div>
    <div class="nav-item" data-page="pdv" onclick="showPage('pdv')">ğŸ§¾ PDV</div>
    <div class="nav-item" data-page="porez" onclick="showPage('porez')">ğŸ“‘ Porez dobit</div>
    <div class="nav-item" data-page="joppd" onclick="showPage('joppd')">ğŸ“„ JOPPD</div>
    <div class="nav-item" data-page="gfi" onclick="showPage('gfi')">ğŸ“Š GFI</div>
    <div class="nav-item" data-page="ios" onclick="showPage('ios')">ğŸ”„ IOS</div>
    <div class="nav-item" data-page="eracun" onclick="showPage('eracun')">ğŸ“¨ E-raÄun</div>

    <div class="section-title">IzvjeÅ¡taji</div>
    <div class="nav-item" data-page="dashboard" onclick="showPage('dashboard')">ğŸ“Š Dashboard</div>
    <div class="nav-item" data-page="deadlines" onclick="showPage('deadlines')">ğŸ“… Rokovi</div>
    <div class="nav-item" data-page="clients" onclick="showPage('clients')">ğŸ¢ Klijenti</div>

    <div class="section-title">Sustav</div>
    <div class="nav-item" data-page="export" onclick="showPage('export')">ğŸ’¾ Export</div>
    <div class="nav-item" data-page="system" onclick="showPage('system')">âš™ï¸ Status</div>
    <div style="margin-top:auto;padding:10px 14px;border-top:1px solid var(--border)">
      <button onclick="toggleTheme()" style="background:var(--bg3);color:var(--text2);border:1px solid var(--border);padding:8px 14px;border-radius:var(--radius);cursor:pointer;width:100%;font-size:13px" id="themeBtn">ğŸŒ™ Tamna tema</button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main">
    <!-- CHAT PAGE -->
    <div class="chat-page active" id="page-chat">
      <div class="chat-client-select">
        <span>Klijent:</span>
        <select id="chatClient" onchange="switchChatClient()">
          <option value="">OpÄ‡enito (bez klijenta)</option>
        </select>
        <button onclick="clearChat()" style="margin-left:auto;background:var(--bg3);color:var(--text2);border:1px solid var(--border);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">ObriÅ¡i chat</button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="chat-msg assistant">
          <div class="avatar">N</div>
          <div class="bubble">Pozdrav! Ja sam Nyx Light â€” RaÄunovoÄ‘a. Postavite mi pitanje o kontiranju, porezima, zakonima ili mi poÅ¡aljite dokument za obradu. ğŸŒ™</div>
        </div>
      </div>
      <div class="typing" id="chatTyping">Nyx razmiÅ¡lja <span class="dots"><span>.</span><span>.</span><span>.</span></span></div>
      <div class="chat-input-area">
        <textarea id="chatInput" placeholder="UpiÅ¡ite poruku..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
        <button id="chatSend" onclick="sendChat()">PoÅ¡alji</button>
      </div>
    </div>

    <!-- PENDING PAGE -->
    <div class="page" id="page-pending">
      <div class="page-header">
        <h2>ğŸ“‹ KnjiÅ¾enja za odobrenje</h2>
        <p>Human-in-the-Loop: svako knjiÅ¾enje mora biti odobreno</p>
      </div>
      <div class="toolbar">
        <select id="pendingFilter" onchange="loadPending()">
          <option value="">Svi klijenti</option>
        </select>
        <button onclick="loadPending()">ğŸ”„ OsvjeÅ¾i</button>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>Datum</th><th>Klijent</th><th>Opis</th><th>Duguje</th><th>PotraÅ¾uje</th><th>Iznos</th><th>Conf.</th><th>Akcije</th></tr></thead>
          <tbody id="pendingBody"></tbody>
        </table>
      </div>
    </div>

    <!-- BOOKINGS PAGE -->
    <div class="page" id="page-bookings">
      <div class="page-header">
        <h2>ğŸ“’ Sva knjiÅ¾enja</h2>
        <p>Pregled svih obraÄ‘enih knjiÅ¾enja</p>
      </div>
      <div class="toolbar">
        <select id="bookingsFilter"><option value="">Svi statusi</option><option value="approved">Odobreno</option><option value="pending">Na Äekanju</option><option value="rejected">Odbijeno</option></select>
        <select id="bookingsClient"><option value="">Svi klijenti</option></select>
        <button onclick="loadBookings()">ğŸ”„ OsvjeÅ¾i</button>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>ID</th><th>Datum</th><th>Klijent</th><th>Opis</th><th>D/P</th><th>Iznos</th><th>Status</th><th>Odobrio</th></tr></thead>
          <tbody id="bookingsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- UPLOAD PAGE -->
    <div class="page" id="page-upload">
      <div class="page-header">
        <h2>ğŸ“¤ Upload dokumenata</h2>
        <p>PDF, slike, MT940, XML â€” sustav automatski prepoznaje tip</p>
      </div>
      <div class="toolbar">
        <select id="uploadClient"><option value="">Odaberi klijenta</option></select>
      </div>
      <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()"
           ondragover="event.preventDefault();this.classList.add('dragover')"
           ondragleave="this.classList.remove('dragover')"
           ondrop="event.preventDefault();this.classList.remove('dragover');handleDrop(event)">
        <p style="font-size:40px;margin-bottom:12px">ğŸ“„</p>
        <p>Kliknite ili povucite datoteke ovdje</p>
        <p style="font-size:12px;margin-top:8px">PDF, JPEG, PNG, MT940, CSV, XML</p>
        <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.mt940,.csv,.xml,.xlsx" style="display:none" onchange="handleFiles(this.files)">
      </div>
      <div id="uploadResults" style="margin-top:20px"></div>
    </div>

    <!-- DASHBOARD PAGE -->
    <div class="page" id="page-dashboard">
      <div class="page-header">
        <h2>ğŸ“Š Dashboard</h2>
        <p>Pregled sustava u realnom vremenu</p>
      </div>
      <div class="cards" id="dashCards"></div>
      <div class="charts-grid" id="dashCharts">
        <div class="chart-box"><h4 style="margin:0 0 8px">ğŸ“ˆ KnjiÅ¾enja po danima</h4><canvas id="chartBookings"></canvas></div>
        <div class="chart-box"><h4 style="margin:0 0 8px">ğŸ§© KoriÅ¡tenje modula</h4><canvas id="chartModules"></canvas></div>
        <div class="chart-box"><h4 style="margin:0 0 8px">ğŸ¢ Raspodjela po klijentima</h4><canvas id="chartClients"></canvas></div>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>Modul</th><th>Status</th><th>Procesiranih</th><th>UspjeÅ¡nost</th></tr></thead>
          <tbody id="dashModules"></tbody>
        </table>
      </div>
    </div>

    <!-- DEADLINES PAGE -->
    <div class="page" id="page-deadlines">
      <div class="page-header">
        <h2>ğŸ“… NadolazeÄ‡i rokovi</h2>
        <p>Porezni rokovi, predaje, obveze</p>
      </div>
      <div id="deadlinesList"></div>
    </div>

    <!-- CLIENTS PAGE -->
    <div class="page" id="page-clients">
      <div class="page-header">
        <h2>ğŸ¢ Klijenti</h2>
        <p>Upravljanje klijentima ureda</p>
      </div>
      <div class="toolbar">
        <button onclick="showAddClient()">+ Novi klijent</button>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead><tr><th>Naziv</th><th>OIB</th><th>ERP</th><th>KnjiÅ¾enja</th><th>Status</th></tr></thead>
          <tbody id="clientsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- EXPORT PAGE -->
    <div class="page" id="page-export">
      <div class="page-header">
        <h2>ğŸ’¾ Export u ERP</h2>
        <p>Izvoz odobrenih knjiÅ¾enja u CPP ili Synesis</p>
      </div>
      <div class="toolbar">
        <select id="exportClient"><option value="">Odaberi klijenta</option></select>
        <select id="exportFormat"><option value="cpp_xml">CPP XML</option><option value="synesis_csv">Synesis CSV</option><option value="json">JSON</option><option value="xlsx">Excel</option></select>
        <button class="btn-export" onclick="doExport()">ğŸ’¾ Exportiraj</button>
      </div>
      <div id="exportResults"></div>
    </div>

    <!-- PAYROLL PAGE -->
    <div class="page" id="page-payroll">
      <div class="page-header"><h2>ğŸ’° ObraÄun plaÄ‡e</h2><p>Bruto/neto kalkulator za 2026. godinu</p></div>
      <div class="payroll-form">
        <div><label>Bruto plaÄ‡a (EUR)</label><input type="number" id="prBruto" value="2000" step="50"></div>
        <div><label>Grad (prirez)</label><select id="prGrad"><option value="zagreb">Zagreb (18%)</option><option value="split">Split (15%)</option><option value="rijeka">Rijeka (15%)</option><option value="osijek">Osijek (13%)</option><option value="zadar">Zadar (12%)</option></select></div>
        <div><label>Bonus (EUR)</label><input type="number" id="prBonus" value="0" step="50"></div>
        <div><label>Prehrana neoporezivo (EUR)</label><input type="number" id="prPrehrana" value="150" max="150"></div>
        <div><label>Prijevoz (EUR)</label><input type="number" id="prPrijevoz" value="0"></div>
        <div><label>UzdrÅ¾avana djeca</label><select id="prDjeca"><option value="0">Bez</option><option value="1">1 dijete</option><option value="2">2 djece</option><option value="3">3 djece</option></select></div>
      </div>
      <div style="margin-top:16px"><button class="btn-export" onclick="calcPayroll()">IzraÄunaj</button>
      <button style="background:var(--bg3);color:var(--text2);border:1px solid var(--border);padding:10px 20px;border-radius:var(--radius);cursor:pointer;margin-left:8px" onclick="calcMinimalna()">Min. plaÄ‡a</button></div>
      <div class="payroll-result" id="payrollResult" style="display:none"></div>
    </div>

    <!-- AMORTIZACIJA PAGE -->
    <div class="page" id="page-amort">
      <div class="page-header"><h2>ğŸ­ Amortizacija</h2><p>IzraÄun porezno priznatih stopa</p></div>
      <div class="payroll-form" style="max-width:600px">
        <div><label>Nabavna vrijednost (EUR)</label><input type="number" id="amNabavna" value="10000" step="500"></div>
        <div><label>Grupa (1-5)</label><select id="amGrupa"><option value="1">1 â€” Zgrade (5%)</option><option value="2" selected>2 â€” Auti/oprema (20%)</option><option value="3">3 â€” RaÄunala (50%)</option><option value="4">4 â€” Ostalo (25%)</option><option value="5">5 â€” Goodwill (5%)</option></select></div>
        <div><label>Metoda</label><select id="amMetoda"><option value="linearna">Linearna</option><option value="dvostruka">Dvostruka (ubrzana)</option></select></div>
      </div>
      <div style="margin-top:16px"><button class="btn-export" onclick="calcAmort()">IzraÄunaj</button></div>
      <div class="payroll-result" id="amortResult" style="display:none"></div>
    </div>

    <!-- BANK PAGE -->
    <div class="page" id="page-bank">
      <div class="page-header"><h2>ğŸ¦ Bankovni izvodi</h2><p>MT940/CSV parser â€” Erste, Zaba, PBZ</p></div>
      <div class="payroll-form" style="max-width:600px">
        <div><label>Banka</label><select id="bankSelect"><option value="erste">Erste</option><option value="zaba">Zaba</option><option value="pbz">PBZ</option><option value="auto">Auto-detekcija</option></select></div>
        <div><label>Datoteka izvoda</label><input type="file" id="bankFile" accept=".csv,.mt940,.txt,.sta"></div>
        <div><label>Klijent</label><select id="bankClient" class="client-select"></select></div>
      </div>
      <div style="margin-top:16px"><button class="btn-export" onclick="parseBank()">Parsiraj izvod</button></div>
      <div class="payroll-result" id="bankResult" style="display:none"></div>
    </div>

    <!-- KONTIRANJE PAGE -->
    <div class="page" id="page-kontiranje">
      <div class="page-header"><h2>ğŸ“ Kontiranje</h2><p>AI prijedlog konta i temeljnica</p></div>
      <div class="payroll-form" style="max-width:700px">
        <div><label>Tip dokumenta</label><select id="kontTip"><option value="ulazni_racun">Ulazni raÄun</option><option value="izlazni_racun">Izlazni raÄun</option><option value="banka_uplata">Banka â€” uplata</option><option value="banka_isplata">Banka â€” isplata</option><option value="blagajna">Blagajna</option><option value="putni_nalog">Putni nalog</option><option value="placa">PlaÄ‡a</option><option value="amortizacija">Amortizacija</option></select></div>
        <div><label>Opis</label><input type="text" id="kontOpis" placeholder="npr. Uredski materijal, gorivo, telefon..."></div>
        <div><label>DobavljaÄ / Partner</label><input type="text" id="kontPartner" placeholder="Naziv ili OIB"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div><label>Iznos (EUR)</label><input type="number" id="kontIznos" value="1000" step="0.01"></div>
          <div><label>PDV stopa (%)</label><select id="kontPDV"><option value="25">25%</option><option value="13">13%</option><option value="5">5%</option><option value="0">0% (osloboÄ‘eno)</option></select></div>
        </div>
      </div>
      <div style="margin-top:16px"><button class="btn-export" onclick="suggestKonto()">PredloÅ¾i kontiranje</button></div>
      <div class="payroll-result" id="kontResult" style="display:none"></div>
    </div>

    <!-- BLAGAJNA PAGE -->
    <div class="page" id="page-blagajna">
      <div class="page-header"><h2>ğŸ’µ Blagajna</h2><p>BlagajniÄki nalozi â€” limit 10.000 EUR</p></div>
      <div class="payroll-form" style="max-width:600px">
        <div><label>Tip</label><select id="blagTip"><option value="isplata">Isplata</option><option value="uplata">Uplata</option></select></div>
        <div><label>Iznos (EUR)</label><input type="number" id="blagIznos" value="500" step="0.01"></div>
        <div><label>Opis</label><input type="text" id="blagOpis" placeholder="Svrha isplate/uplate"></div>
        <div><label>Partner OIB</label><input type="text" id="blagOIB" placeholder="11 znamenaka"></div>
        <div><label>PoÄetno stanje (EUR)</label><input type="number" id="blagPocetno" value="0" step="0.01"></div>
      </div>
      <div style="margin-top:16px"><button class="btn-export" onclick="validateBlagajna()">Provjeri nalog</button></div>
      <div class="payroll-result" id="blagResult" style="display:none"></div>
    </div>

    <!-- PUTNI NALOZI PAGE -->
    <div class="page" id="page-putni">
      <div class="page-header"><h2>ğŸš— Putni nalozi</h2><p>ObraÄun dnevnica i km-naknade (0,40 EUR/km)</p></div>
      <div class="payroll-form" style="max-width:700px">
        <div><label>Zaposlenik</label><input type="text" id="pnZaposlenik" placeholder="Ime i prezime"></div>
        <div><label>OdrediÅ¡te</label><input type="text" id="pnOdrediste" placeholder="npr. Split"></div>
        <div><label>Svrha puta</label><input type="text" id="pnSvrha" placeholder="Poslovni razlog"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div><label>Datum polaska</label><input type="date" id="pnDatumOd"></div>
          <div><label>Datum povratka</label><input type="date" id="pnDatumDo"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div><label>Kilometri</label><input type="number" id="pnKm" value="0"></div>
          <div><label>Zemlja</label><select id="pnZemlja"><option value="rh">Hrvatska</option><option value="de">NjemaÄka</option><option value="at">Austrija</option><option value="si">Slovenija</option><option value="it">Italija</option><option value="hu">MaÄ‘arska</option><option value="rs">Srbija</option><option value="ba">BiH</option></select></div>
        </div>
      </div>
      <div style="margin-top:16px"><button class="btn-export" onclick="calcPutni()">ObraÄunaj</button></div>
      <div class="payroll-result" id="putniResult" style="display:none"></div>
    </div>

    <!-- PDV PAGE -->
    <div class="page" id="page-pdv">
      <div class="page-header"><h2>ğŸ§¾ PDV prijava</h2><p>PP-PDV obrazac â€” rok do 20. u mjesecu</p></div>
      <div class="payroll-form" style="max-width:600px">
        <div><label>Klijent</label><select id="pdvClient" class="client-select"></select></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div><label>Mjesec</label><select id="pdvMjesec"><option value="1">SijeÄanj</option><option value="2">VeljaÄa</option><option value="3">OÅ¾ujak</option><option value="4">Travanj</option><option value="5">Svibanj</option><option value="6">Lipanj</option><option value="7">Srpanj</option><option value="8">Kolovoz</option><option value="9">Rujan</option><option value="10">Listopad</option><option value="11">Studeni</option><option value="12">Prosinac</option></select></div>
          <div><label>Godina</label><input type="number" id="pdvGodina" value="2026"></div>
        </div>
      </div>
      <div style="margin-top:16px"><button class="btn-export" onclick="genPDV()">Generiraj PP-PDV</button></div>
      <div class="payroll-result" id="pdvResult" style="display:none"></div>
    </div>

    <!-- POREZ NA DOBIT PAGE -->
    <div class="page" id="page-porez">
      <div class="page-header"><h2>ğŸ“‘ Porez na dobit</h2><p>PD obrazac â€” 10% (&lt;1M) / 18% (â‰¥1M)</p></div>
      <div class="payroll-form" style="max-width:600px">
        <div><label>Ukupni prihodi (EUR)</label><input type="number" id="pdPrihodi" value="500000" step="1000"></div>
        <div><label>Ukupni rashodi (EUR)</label><input type="number" id="pdRashodi" value="400000" step="1000"></div>
        <div><label>Reprezentacija (EUR)</label><input type="number" id="pdReprez" value="0" step="100"></div>
        <div><label>Amortizacija iznad (EUR)</label><input type="number" id="pdAmort" value="0" step="100"></div>
        <div><label>Kazne i penali (EUR)</label><input type="number" id="pdKazne" value="0"></div>
        <div><label>Preneseni gubitak (EUR)</label><input type="number" id="pdGubitak" value="0" step="1000"></div>
      </div>
      <div style="margin-top:16px"><button class="btn-export" onclick="calcPorezDobit()">IzraÄunaj PD</button></div>
      <div class="payroll-result" id="porezResult" style="display:none"></div>
    </div>

    <!-- JOPPD PAGE -->
    <div class="page" id="page-joppd">
      <div class="page-header"><h2>ğŸ“„ JOPPD</h2><p>XML obrazac za ePorezna â€” rok do 15. u mjesecu</p></div>
      <div class="payroll-form" style="max-width:600px">
        <div><label>Klijent</label><select id="joppdClient" class="client-select"></select></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div><label>Mjesec</label><input type="number" id="joppdMjesec" value="1" min="1" max="12"></div>
          <div><label>Godina</label><input type="number" id="joppdGodina" value="2026"></div>
        </div>
        <div><label>Tip</label><select id="joppdTip"><option value="placa">PlaÄ‡a</option><option value="drugi_dohodak">Drugi dohodak</option><option value="dividenda">Dividenda</option></select></div>
      </div>
      <div style="margin-top:16px"><button class="btn-export" onclick="genJOPPD()">Generiraj JOPPD XML</button></div>
      <div class="payroll-result" id="joppdResult" style="display:none"></div>
    </div>

    <!-- GFI PAGE -->
    <div class="page" id="page-gfi">
      <div class="page-header"><h2>ğŸ“Š GFI</h2><p>GodiÅ¡nji financijski izvjeÅ¡taji za FINA-u â€” rok 30.4.</p></div>
      <div class="payroll-form" style="max-width:600px">
        <div><label>Klijent</label><select id="gfiClient" class="client-select"></select></div>
        <div><label>Godina</label><input type="number" id="gfiGodina" value="2025"></div>
        <div><label>VeliÄina</label><select id="gfiVelicina"><option value="mikro">Mikro</option><option value="mali" selected>Mali</option><option value="srednji">Srednji</option><option value="veliki">Veliki</option></select></div>
        <div><label>Tip izvjeÅ¡taja</label><select id="gfiTip"><option value="bilanca">Bilanca + RDG</option><option value="biljeske">BiljeÅ¡ke</option><option value="puni">Puni paket</option></select></div>
      </div>
      <div style="margin-top:16px"><button class="btn-export" onclick="genGFI()">Generiraj GFI XML</button></div>
      <div class="payroll-result" id="gfiResult" style="display:none"></div>
    </div>

    <!-- IOS PAGE -->
    <div class="page" id="page-ios">
      <div class="page-header"><h2>ğŸ”„ IOS usklaÄ‘ivanja</h2><p>Generiranje i praÄ‡enje IOS obrazaca</p></div>
      <div class="payroll-form" style="max-width:600px">
        <div><label>Klijent</label><select id="iosClient" class="client-select"></select></div>
        <div><label>Partner OIB</label><input type="text" id="iosPartnerOIB" placeholder="11 znamenaka"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div><label>Datum od</label><input type="date" id="iosDatumOd"></div>
          <div><label>Datum do</label><input type="date" id="iosDatumDo"></div>
        </div>
      </div>
      <div style="margin-top:16px"><button class="btn-export" onclick="genIOS()">Generiraj IOS</button></div>
      <div class="payroll-result" id="iosResult" style="display:none"></div>
    </div>

    <!-- E-RACUN PAGE -->
    <div class="page" id="page-eracun">
      <div class="page-header"><h2>ğŸ“¨ E-raÄun</h2><p>UBL/CII â€” Peppol EN 16931</p></div>
      <div class="payroll-form" style="max-width:600px">
        <div><label>Akcija</label><select id="eracunAction"><option value="generate">Generiraj e-raÄun</option><option value="validate">Validiraj XML</option></select></div>
        <div><label>Format</label><select id="eracunFormat"><option value="ubl">UBL 2.1</option><option value="cii">CII (Cross-Industry Invoice)</option><option value="zugferd">ZUGFeRD</option></select></div>
        <div><label>XML datoteka (za validaciju)</label><input type="file" id="eracunFile" accept=".xml"></div>
      </div>
      <div style="margin-top:16px"><button class="btn-export" onclick="processEracun()">IzvrÅ¡i</button></div>
      <div class="payroll-result" id="eracunResult" style="display:none"></div>
    </div>

    <!-- SYSTEM PAGE -->
    <div class="page" id="page-system">
      <div class="page-header">
        <h2>âš™ï¸ Status sustava</h2>
        <p>Hardver, AI modeli, memorija, baza znanja</p>
      </div>
      <div class="cards" id="sysCards"></div>
      <pre id="sysDetails" style="background:var(--bg3);padding:16px;border-radius:var(--radius);font-size:12px;overflow-x:auto;max-height:500px;overflow-y:auto"></pre>
    </div>
  </div>
</div>

<!-- CORRECT MODAL -->
<div class="modal-overlay" id="correctModal">
  <div class="modal">
    <h3>âœï¸ Ispravi knjiÅ¾enje</h3>
    <input type="hidden" id="correctBookingId">
    <label style="font-size:13px;color:var(--text2)">Konto duguje:</label>
    <input id="correctDuguje" placeholder="npr. 4010">
    <label style="font-size:13px;color:var(--text2)">Konto potraÅ¾uje:</label>
    <input id="correctPotrazuje" placeholder="npr. 2200">
    <label style="font-size:13px;color:var(--text2)">Razlog ispravka:</label>
    <textarea id="correctReason" placeholder="Objasni ispravak..." rows="3"></textarea>
    <div class="modal-actions">
      <button style="background:var(--bg3);color:var(--text2)" onclick="closeModal('correctModal')">Odustani</button>
      <button style="background:var(--green);color:white" onclick="submitCorrection()">Spremi ispravak</button>
    </div>
  </div>
</div>

<!-- ADD CLIENT MODAL -->
<div class="modal-overlay" id="clientModal">
  <div class="modal">
    <h3>ğŸ¢ Novi klijent</h3>
    <input id="clientName" placeholder="Naziv tvrtke">
    <input id="clientOIB" placeholder="OIB (11 znamenki)" maxlength="11">
    <select id="clientERP"><option value="CPP">CPP</option><option value="Synesis">Synesis</option></select>
    <div class="modal-actions">
      <button style="background:var(--bg3);color:var(--text2)" onclick="closeModal('clientModal')">Odustani</button>
      <button style="background:var(--accent);color:white" onclick="submitClient()">Dodaj</button>
    </div>
  </div>
</div>

<script>
const API='/api';
let token='',currentUser=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value;
  const err=document.getElementById('loginError');
  if(!u||!p){err.textContent='Unesite korisniÄko ime i lozinku';err.style.display='block';return}
  try{
    const r=await fetch(API+'/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
    const d=await r.json();
    if(!r.ok){err.textContent=d.detail||'GreÅ¡ka pri prijavi';err.style.display='block';return}
    token=d.token;currentUser=d.user;
    localStorage.setItem('nyx_token',token);
    localStorage.setItem('nyx_user',JSON.stringify(currentUser));
    showApp();
  }catch(e){err.textContent='Server nije dostupan';err.style.display='block'}
}
function doLogout(){token='';currentUser=null;localStorage.removeItem('nyx_token');localStorage.removeItem('nyx_user');
  document.getElementById('app').classList.remove('active');document.getElementById('loginScreen').style.display='flex'}
function showApp(){
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('app').classList.add('active');
  document.getElementById('userName').textContent=currentUser.display_name||currentUser.username;
  document.getElementById('userRole').textContent=currentUser.role;
  loadClients();loadPending();loadDashboard();loadDeadlines();loadClientSelects();
}
function authHeaders(){return{'Authorization':'Bearer '+token,'Content-Type':'application/json'}}

async function fetchAPI(path, opts={}){
  const headers = {'Authorization':'Bearer '+token};
  if(!opts.raw) headers['Content-Type']='application/json';
  const fetchOpts = {method:opts.method||'GET', headers};
  if(opts.body){
    fetchOpts.body = opts.body;
    if(opts.raw) delete headers['Content-Type']; // FormData sets its own
  }
  try{
    const r = await fetch(API+path.replace('/api',''), fetchOpts);
    if(!r.ok){
      const err = await r.json().catch(()=>({detail:r.statusText}));
      showToast(err.detail||'GreÅ¡ka '+r.status,'error');
      return err;
    }
    return await r.json();
  }catch(e){
    showToast('Server nije dostupan: '+e.message,'error');
    return {error:e.message};
  }
}

function showToast(msg,type='info'){
  const t=document.createElement('div');
  t.style.cssText=`position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:8px;z-index:9999;font-size:14px;color:white;animation:fadeIn .3s;max-width:400px;background:${type==='error'?'var(--red)':type==='success'?'var(--green)':'var(--accent)'}`;
  t.textContent=msg;document.body.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .3s';setTimeout(()=>t.remove(),300)},4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name){
  document.querySelectorAll('.page,.chat-page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const el=document.getElementById('page-'+name);
  if(el)el.classList.add('active');
  document.querySelector(`[data-page="${name}"]`)?.classList.add('active');
  if(name==='pending')loadPending();
  if(name==='bookings')loadBookings();
  if(name==='dashboard')loadDashboard();
  if(name==='system')loadSystemStatus();
  if(name==='deadlines')loadDeadlines();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendChat(){
  const input=document.getElementById('chatInput');
  const msg=input.value.trim();if(!msg)return;
  input.value='';input.style.height='44px';
  addChatMsg('user',msg);
  document.getElementById('chatTyping').classList.add('active');
  document.getElementById('chatSend').disabled=true;
  try{
    const r=await fetch(API+'/chat',{method:'POST',headers:authHeaders(),
      body:JSON.stringify({message:msg,client_id:document.getElementById('chatClient').value})});
    const d=await r.json();
    addChatMsg('assistant',d.content||d.detail||'GreÅ¡ka');
  }catch(e){addChatMsg('assistant','âš ï¸ Server nije dostupan: '+e.message)}
  document.getElementById('chatTyping').classList.remove('active');
  document.getElementById('chatSend').disabled=false;
}
function addChatMsg(role,text){
  const div=document.createElement('div');div.className='chat-msg '+role;
  div.innerHTML=`<div class="avatar">${role==='user'?'ğŸ‘¤':'N'}</div><div class="bubble">${escHtml(text)}</div>`;
  const c=document.getElementById('chatMessages');c.appendChild(div);c.scrollTop=c.scrollHeight;
}
function clearChat(){document.getElementById('chatMessages').innerHTML='';addChatMsg('assistant','Chat obrisan. Kako vam mogu pomoÄ‡i?')}
function switchChatClient(){}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PENDING APPROVALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPending(){
  try{
    const cid=document.getElementById('pendingFilter')?.value||'';
    const r=await fetch(API+'/pending?client_id='+cid,{headers:authHeaders()});
    const data=await r.json();const items=data.items||data||[];
    const badge=document.getElementById('pendingBadge');
    badge.textContent=items.length;badge.style.display=items.length?'inline':'none';
    const tb=document.getElementById('pendingBody');tb.innerHTML='';
    items.forEach(b=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${b.datum_dokumenta||b.created_at||''}</td><td>${b.client_id}</td>
        <td>${escHtml(b.opis||'')}</td><td>${b.konto_duguje||''}</td><td>${b.konto_potrazuje||''}</td>
        <td style="text-align:right;font-weight:600">${fmt(b.iznos)}</td>
        <td><span style="color:${b.confidence>=0.9?'var(--green)':b.confidence>=0.7?'var(--yellow)':'var(--red)'}">${(b.confidence*100).toFixed(0)}%</span></td>
        <td>
          <button class="btn-sm btn-approve" onclick="approveBooking('${b.id}')">âœ“</button>
          <button class="btn-sm btn-reject" onclick="rejectBooking('${b.id}')">âœ—</button>
          <button class="btn-sm btn-correct" onclick="showCorrect('${b.id}','${b.konto_duguje||''}','${b.konto_potrazuje||''}')">âœï¸</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){console.error('loadPending',e)}
}
async function approveBooking(id){
  await fetch(API+'/approve/'+id,{method:'POST',headers:authHeaders()});toast('KnjiÅ¾enje odobreno','success');loadPending();
}
async function rejectBooking(id){
  if(!confirm('Odbiti knjiÅ¾enje?'))return;
  await fetch(API+'/reject/'+id,{method:'POST',headers:authHeaders(),body:JSON.stringify({reason:'Odbijeno od korisnika'})});toast('KnjiÅ¾enje odbijeno','info');loadPending();
}
function showCorrect(id,d,p){
  document.getElementById('correctBookingId').value=id;
  document.getElementById('correctDuguje').value=d;
  document.getElementById('correctPotrazuje').value=p;
  document.getElementById('correctModal').classList.add('active');
}
async function submitCorrection(){
  const id=document.getElementById('correctBookingId').value;
  const body={konto_duguje:document.getElementById('correctDuguje').value,
    konto_potrazuje:document.getElementById('correctPotrazuje').value,
    reason:document.getElementById('correctReason').value};
  await fetch(API+'/correct/'+id,{method:'POST',headers:authHeaders(),body:JSON.stringify(body)});
  closeModal('correctModal');toast('Ispravak spremljen','success');loadPending();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOKINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadBookings(){
  try{
    const status=document.getElementById('bookingsFilter').value;
    const cid=document.getElementById('bookingsClient').value;
    const r=await fetch(API+`/bookings?status=${status}&client_id=${cid}`,{headers:authHeaders()});
    const data=await r.json();const items=data.items||data||[];
    const tb=document.getElementById('bookingsBody');tb.innerHTML='';
    items.forEach(b=>{
      const tr=document.createElement('tr');
      const sc=b.status==='approved'?'status-approved':b.status==='pending'?'status-pending':'status-rejected';
      tr.innerHTML=`<td style="font-size:11px;color:var(--text2)">${(b.id||'').substring(0,12)}</td>
        <td>${b.datum_dokumenta||b.created_at||''}</td><td>${b.client_id}</td>
        <td>${escHtml(b.opis||'')}</td><td>${b.konto_duguje||''}/${b.konto_potrazuje||''}</td>
        <td style="text-align:right">${fmt(b.iznos)}</td>
        <td><span class="status-badge ${sc}">${b.status}</span></td>
        <td>${b.approved_by||''}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){console.error('loadBookings',e)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadClients(){
  try{
    const r=await fetch(API+'/clients',{headers:authHeaders()});
    const data=await r.json();const items=data.items||data||[];
    const tb=document.getElementById('clientsBody');tb.innerHTML='';
    // Populate all client selectors
    ['chatClient','pendingFilter','bookingsClient','uploadClient','exportClient'].forEach(sid=>{
      const sel=document.getElementById(sid);if(!sel)return;
      const first=sel.options[0];sel.innerHTML='';sel.appendChild(first);
      items.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;sel.appendChild(o)});
    });
    items.forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><strong>${escHtml(c.name)}</strong></td><td>${c.oib||''}</td>
        <td>${c.erp_system||'CPP'}</td><td>${c.bookings_count||0}</td>
        <td><span class="status-badge ${c.active?'status-approved':'status-rejected'}">${c.active?'Aktivan':'Neaktivan'}</span></td>`;
      tb.appendChild(tr);
    });
  }catch(e){console.error('loadClients',e)}
}
function showAddClient(){document.getElementById('clientModal').classList.add('active')}
async function submitClient(){
  const body={name:document.getElementById('clientName').value,
    oib:document.getElementById('clientOIB').value,
    erp_system:document.getElementById('clientERP').value};
  await fetch(API+'/clients',{method:'POST',headers:authHeaders(),body:JSON.stringify(body)});
  closeModal('clientModal');toast('Klijent dodan','success');loadClients();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard(){
  try{
    const r=await fetch(API+'/dashboard',{headers:authHeaders()});const d=await r.json();
    const cards=document.getElementById('dashCards');
    cards.innerHTML=`
      <div class="card"><div class="card-icon">ğŸ“‹</div><div class="card-value">${d.pending||0}</div><div class="card-label">Na Äekanju</div></div>
      <div class="card"><div class="card-icon">âœ…</div><div class="card-value">${d.approved||0}</div><div class="card-label">Odobreno</div></div>
      <div class="card"><div class="card-icon">ğŸ“’</div><div class="card-value">${d.total_bookings||0}</div><div class="card-label">Ukupno knjiÅ¾enja</div></div>
      <div class="card"><div class="card-icon">ğŸ¢</div><div class="card-value">${d.clients||0}</div><div class="card-label">Klijenata</div></div>
      <div class="card"><div class="card-icon">âœï¸</div><div class="card-value">${d.corrections||0}</div><div class="card-label">Ispravaka</div></div>
      <div class="card"><div class="card-icon">ğŸ‘¥</div><div class="card-value">${d.active_sessions||0}</div><div class="card-label">Aktivnih sesija</div></div>`;
  }catch(e){console.error('dashboard',e)}
  // Load charts after cards
  loadDashboardCharts();
}

// Chart instances (destroy before re-create to avoid memory leak)
let _chartInstances={};
function _getOrCreateChart(canvasId, config){
  if(_chartInstances[canvasId]){_chartInstances[canvasId].destroy()}
  const ctx=document.getElementById(canvasId);
  if(!ctx)return null;
  const chart=new Chart(ctx,config);
  _chartInstances[canvasId]=chart;
  return chart;
}

async function loadDashboardCharts(){
  if(typeof Chart==='undefined'){console.warn('Chart.js not loaded');return}
  try{
    const r=await fetch(API+'/dashboard/chart-data?period=week',{headers:authHeaders()});
    const d=await r.json();

    // 1. KnjiÅ¾enja line chart
    const bc=d.bookings_chart;
    if(bc){
      _getOrCreateChart('chartBookings',{
        type:'line',
        data:{
          labels:bc.labels,
          datasets:bc.datasets.map(ds=>({
            label:ds.label,
            data:ds.data,
            borderColor:ds.color,
            backgroundColor:ds.color+'20',
            fill:true,
            tension:0.3,
            pointRadius:3,
          }))
        },
        options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{position:'bottom',labels:{color:'#9ca3af',font:{size:11}}}},
          scales:{x:{ticks:{color:'#9ca3af'}},y:{beginAtZero:true,ticks:{color:'#9ca3af'}}}
        }
      });
    }

    // 2. Module usage bar chart
    const mu=d.module_usage;
    if(mu){
      _getOrCreateChart('chartModules',{
        type:'bar',
        data:{
          labels:mu.labels,
          datasets:[{
            label:'Poziva',
            data:mu.data,
            backgroundColor:['#6366f1','#8b5cf6','#a78bfa','#c4b5fd','#22c55e','#f59e0b'],
            borderRadius:6,
          }]
        },
        options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{display:false}},
          scales:{x:{ticks:{color:'#9ca3af'}},y:{beginAtZero:true,ticks:{color:'#9ca3af'}}}
        }
      });
    }

    // 3. Client distribution doughnut
    const cd=d.client_distribution;
    if(cd){
      _getOrCreateChart('chartClients',{
        type:'doughnut',
        data:{
          labels:cd.labels,
          datasets:[{
            data:cd.data,
            backgroundColor:['#6366f1','#22c55e','#f59e0b','#64748b'],
            borderWidth:0,
          }]
        },
        options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{position:'bottom',labels:{color:'#9ca3af',font:{size:11}}}}
        }
      });
    }
  }catch(e){console.error('chart-data',e)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEADLINES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDeadlines(){
  try{
    const r=await fetch(API+'/deadlines',{headers:authHeaders()});const d=await r.json();
    const items=d.items||d||[];const el=document.getElementById('deadlinesList');el.innerHTML='';
    if(!items.length){el.innerHTML='<p style="color:var(--text2)">Nema nadolazeÄ‡ih rokova.</p>';return}
    items.forEach(dl=>{
      const days=dl.days_remaining!=null?dl.days_remaining:'?';
      const color=days<=3?'var(--red)':days<=7?'var(--yellow)':'var(--green)';
      const div=document.createElement('div');
      div.style.cssText=`background:var(--bg2);border:1px solid var(--border);border-left:4px solid ${color};border-radius:var(--radius);padding:16px;margin-bottom:10px`;
      div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${escHtml(dl.name||dl.title||'')}</strong><br><span style="font-size:13px;color:var(--text2)">${escHtml(dl.description||'')}</span></div>
        <div style="text-align:right"><div style="font-size:22px;font-weight:700;color:${color}">${days}d</div><div style="font-size:12px;color:var(--text2)">${dl.due_date||''}</div></div></div>`;
      el.appendChild(div);
    });
  }catch(e){console.error('deadlines',e)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYSTEM STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSystemStatus(){
  try{
    const r=await fetch(API+'/system/status',{headers:authHeaders()});const d=await r.json();
    const cards=document.getElementById('sysCards');
    cards.innerHTML=`
      <div class="card"><div class="card-icon">ğŸ¤–</div><div class="card-value" style="font-size:14px">${d.model||'N/A'}</div><div class="card-label">AI Model</div></div>
      <div class="card"><div class="card-icon">ğŸ§ </div><div class="card-value">${d.memory_used_gb||'?'} GB</div><div class="card-label">Memorija</div></div>
      <div class="card"><div class="card-icon">ğŸ”§</div><div class="card-value">${d.vllm_status||'?'}</div><div class="card-label">vLLM Status</div></div>
      <div class="card"><div class="card-icon">ğŸ“Š</div><div class="card-value">${d.total_tokens||0}</div><div class="card-label">Ukupno tokena</div></div>`;
    document.getElementById('sysDetails').textContent=JSON.stringify(d,null,2);
  }catch(e){document.getElementById('sysDetails').textContent='Server nedostupan: '+e.message}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doExport(){
  const cid=document.getElementById('exportClient').value;
  const fmt2=document.getElementById('exportFormat').value;
  if(!cid){toast('Odaberite klijenta','error');return}
  try{
    const r=await fetch(API+'/export',{method:'POST',headers:authHeaders(),
      body:JSON.stringify({client_id:cid,format:fmt2})});
    const d=await r.json();
    document.getElementById('exportResults').innerHTML=`<div class="card" style="margin-top:16px">
      <p>âœ… Eksportirano <strong>${d.count||0}</strong> knjiÅ¾enja</p>
      <p style="font-size:13px;color:var(--text2);margin-top:8px">Format: ${fmt2} Â· Datoteka: ${d.filename||'N/A'}</p>
      ${d.download_url?`<a href="${d.download_url}" style="color:var(--accent)" download>â¬‡ï¸ Preuzmi</a>`:''}</div>`;
    toast('Export uspjeÅ¡an','success');
  }catch(e){toast('Export greÅ¡ka: '+e.message,'error')}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleDrop(e){handleFiles(e.dataTransfer.files)}
async function handleFiles(files){
  const cid=document.getElementById('uploadClient').value;
  if(!cid){toast('Odaberite klijenta prije uploada','error');return}
  const results=document.getElementById('uploadResults');results.innerHTML='<p>Uploading...</p>';
  for(const f of files){
    const fd=new FormData();fd.append('file',f);fd.append('client_id',cid);
    try{
      const r=await fetch(API+'/upload',{method:'POST',headers:{'Authorization':'Bearer '+token},body:fd});
      const d=await r.json();
      results.innerHTML+=`<div class="card" style="margin-bottom:8px">
        <strong>${escHtml(f.name)}</strong> â€” ${d.status||'processed'}
        <br><span style="font-size:12px;color:var(--text2)">${escHtml(d.details||JSON.stringify(d))}</span></div>`;
    }catch(e){results.innerHTML+=`<div class="card" style="border-color:var(--red)">âŒ ${escHtml(f.name)}: ${e.message}</div>`}
  }
  loadPending();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function fmt(n){return(n||0).toLocaleString('hr-HR',{minimumFractionDigits:2,maximumFractionDigits:2})+' â‚¬'}
function closeModal(id){document.getElementById(id).classList.remove('active')}
function toast(msg,type='info'){
  const t=document.createElement('div');t.className='toast '+type;t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),3500);
}
// Auto-resize textarea
document.getElementById('chatInput')?.addEventListener('input',function(){this.style.height='44px';this.style.height=Math.min(this.scrollHeight,120)+'px'});
// Password enter
document.getElementById('loginPass')?.addEventListener('keydown',function(e){if(e.key==='Enter')doLogin()});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” check stored token
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const t=localStorage.getItem('nyx_token');const u=localStorage.getItem('nyx_user');
  if(t&&u){token=t;try{currentUser=JSON.parse(u);showApp()}catch(e){doLogout()}}
  // Restore theme
  if(localStorage.getItem('nyx_theme')==='light'){document.body.classList.add('light');const b=document.getElementById('themeBtn');if(b)b.textContent='â˜€ï¸ Svijetla tema'}
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME & MOBILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTheme(){
  document.body.classList.toggle('light');
  const light=document.body.classList.contains('light');
  localStorage.setItem('nyx_theme',light?'light':'dark');
  document.getElementById('themeBtn').textContent=light?'â˜€ï¸ Svijetla tema':'ğŸŒ™ Tamna tema';
}
function toggleMobile(){document.querySelector('.sidebar').classList.toggle('mobile-open')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',function(e){
  if(!token)return;
  if(e.altKey&&e.key==='1'){showPage('chat');e.preventDefault()}
  if(e.altKey&&e.key==='2'){showPage('pending');e.preventDefault()}
  if(e.altKey&&e.key==='3'){showPage('dashboard');e.preventDefault()}
  if(e.altKey&&e.key==='4'){showPage('payroll');e.preventDefault()}
  if(e.altKey&&e.key==='5'){showPage('kontiranje');e.preventDefault()}
  if(e.altKey&&e.key==='6'){showPage('bank');e.preventDefault()}
  if(e.altKey&&e.key==='n'){document.getElementById('chatInput')?.focus();e.preventDefault()}
  if(e.key==='Escape'){document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('active'))}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYROLL CALCULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function calcPayroll(){
  const djeca=parseInt(document.getElementById('prDjeca').value)||0;
  const uzdrzavani=[];
  const tips=['dijete_1','dijete_2','dijete_3','dijete_4','dijete_5+'];
  for(let i=0;i<djeca;i++)uzdrzavani.push({tip:tips[Math.min(i,4)]});
  try{
    const r=await fetch(API+'/payroll/calculate',{method:'POST',headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},
      body:JSON.stringify({bruto:parseFloat(document.getElementById('prBruto').value)||0,
        grad:document.getElementById('prGrad').value,bonus:parseFloat(document.getElementById('prBonus').value)||0,
        prehrana:parseFloat(document.getElementById('prPrehrana').value)||0,prijevoz:parseFloat(document.getElementById('prPrijevoz').value)||0,
        uzdrzavani:uzdrzavani})});
    const d=await r.json();
    document.getElementById('payrollResult').style.display='block';
    document.getElementById('payrollResult').innerHTML=`
      <h3 style="margin-bottom:12px">ObraÄun plaÄ‡e</h3>
      <div class="row total"><span>Bruto plaÄ‡a</span><span>${fmt(d.bruto)}</span></div>
      <div class="row"><span>MIO I (15%)</span><span>- ${fmt(d.mio_i)}</span></div>
      <div class="row"><span>MIO II (5%)</span><span>- ${fmt(d.mio_ii)}</span></div>
      <div class="row"><span>Dohodak</span><span>${fmt(d.dohodak)}</span></div>
      <div class="row"><span>Osobni odbitak</span><span>- ${fmt(d.osobni_odbitak)}</span></div>
      <div class="row"><span>Porezna osnovica</span><span>${fmt(d.porezna_osnovica)}</span></div>
      <div class="row"><span>Porez (${d.detalji?.porez_stopa||'20%'})</span><span>- ${fmt(d.porez)}</span></div>
      <div class="row"><span>Prirez (${d.detalji?.prirez_stopa||''})</span><span>- ${fmt(d.prirez)}</span></div>
      <div class="row total"><span>âœ… NETO</span><span>${fmt(d.neto)}</span></div>
      <div class="row"><span>+ Neoporezivi primici</span><span>${fmt(d.neoporezivo||0)}</span></div>
      <div class="row total"><span>ğŸ’³ Za isplatu</span><span>${fmt(d.za_isplatu)}</span></div>
      <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
        <div class="row"><span>Zdravstveno (16.5%, teret poslodavca)</span><span>${fmt(d.zdravstveno)}</span></div>
        <div class="row total"><span>ğŸ“ˆ Ukupni troÅ¡ak poslodavca</span><span>${fmt(d.trosak_poslodavca)}</span></div>
      </div>`;
  }catch(e){toast('GreÅ¡ka: '+e.message,'error')}
}
async function calcMinimalna(){
  try{
    const r=await fetch(API+'/payroll/minimalna?grad='+document.getElementById('prGrad').value,{headers:{'Authorization':'Bearer '+token}});
    const d=await r.json();
    document.getElementById('prBruto').value=d.bruto;
    calcPayroll();
  }catch(e){toast('GreÅ¡ka: '+e.message,'error')}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AMORTIZACIJA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function calcAmort(){
  try{
    const r=await fetch(API+'/amortizacija/calculate',{method:'POST',headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},
      body:JSON.stringify({nabavna_vrijednost:parseFloat(document.getElementById('amNabavna').value)||0,
        grupa:document.getElementById('amGrupa').value,metoda:document.getElementById('amMetoda').value})});
    const d=await r.json();
    const vijek=d.vijek_god||0;let plan='';
    let preostalo=d.nabavna||0;
    for(let g=1;g<=Math.ceil(vijek);g++){
      const am=Math.min(d.godisnja||0,preostalo);preostalo=Math.max(0,preostalo-am);
      plan+=`<div class="row"><span>Godina ${g}</span><span>${fmt(am)}</span><span style="color:var(--text2)">${fmt(preostalo)}</span></div>`;
    }
    const warn=d.porezno_priznato<(d.nabavna||0)?`<div style="background:#854d0e40;color:var(--yellow);padding:10px;border-radius:var(--radius);margin-bottom:12px">âš ï¸ Porezno priznato samo do ${fmt(d.porezno_priznato)}</div>`:'';
    document.getElementById('amortResult').style.display='block';
    document.getElementById('amortResult').innerHTML=`
      <h3 style="margin-bottom:12px">Plan amortizacije</h3>${warn}
      <div class="row total"><span>Nabavna vrijednost</span><span>${fmt(d.nabavna)}</span></div>
      <div class="row"><span>Stopa</span><span>${d.stopa_pct}% (${document.getElementById('amMetoda').value})</span></div>
      <div class="row"><span>GodiÅ¡nja amortizacija</span><span>${fmt(d.godisnja)}</span></div>
      <div class="row"><span>MjeseÄna amortizacija</span><span>${fmt(d.mjesecna)}</span></div>
      <div class="row"><span>Vijek trajanja</span><span>${vijek} god.</span></div>
      <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
        <div class="row" style="font-weight:600"><span>Godina</span><span>Amort.</span><span>Preostalo</span></div>${plan}
      </div>`;
  }catch(e){toast('GreÅ¡ka: '+e.message,'error')}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED DASHBOARD WITH CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const origLoadDashboard=typeof loadDashboard==='function'?loadDashboard:null;
async function loadDashboardV2(){
  if(origLoadDashboard)await origLoadDashboard();
  try{
    // Load monitoring data for charts
    const mr=await fetch(API+'/health',{headers:{'Authorization':'Bearer '+token}});
    if(mr.ok){
      const md=await mr.json();
      const sysCards=document.getElementById('sysCards');
      if(sysCards&&md.memory){
        // Add memory chart if not exists
        if(!document.getElementById('memChart')){
          const box=document.createElement('div');box.className='chart-box';box.style.gridColumn='1/-1';
          box.innerHTML='<h4 style="margin-bottom:8px;font-size:14px">Memorija (Apple Silicon UMA)</h4><canvas id="memChart" height="100"></canvas>';
          sysCards.parentNode.insertBefore(box,sysCards.nextSibling);
        }
      }
    }
  }catch(e){console.log('Chart load:',e)}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BANK PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function parseBank(){
  const file=document.getElementById('bankFile').files[0];
  if(!file){showToast('Odaberite datoteku izvoda','error');return}
  const fd=new FormData();fd.append('file',file);
  fd.append('bank',document.getElementById('bankSelect').value);
  fd.append('client_id',document.getElementById('bankClient')?.value||'');
  const r=await fetchAPI('/api/bank/parse',{method:'POST',body:fd,raw:true});
  const el=document.getElementById('bankResult');el.style.display='block';
  if(r.transactions){
    let h=`<h3>âœ… ${r.count||r.transactions.length} transakcija</h3><table class="data-table"><tr><th>Datum</th><th>Opis</th><th>Iznos</th><th>Saldo</th></tr>`;
    (r.transactions||[]).slice(0,20).forEach(t=>{
      h+=`<tr><td>${t.datum||''}</td><td>${t.opis||t.description||''}</td><td style="text-align:right;color:${t.iznos<0?'var(--red)':'var(--green)'}">${Number(t.iznos||0).toFixed(2)}</td><td style="text-align:right">${Number(t.saldo||0).toFixed(2)}</td></tr>`;
    });
    el.innerHTML=h+'</table>';
  }else el.innerHTML=`<pre>${JSON.stringify(r,null,2)}</pre>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KONTIRANJE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function suggestKonto(){
  const r=await fetchAPI('/api/kontiranje/suggest',{method:'POST',body:JSON.stringify({
    opis:document.getElementById('kontOpis').value,
    tip:document.getElementById('kontTip').value,
    dobavljac:document.getElementById('kontPartner').value,
    iznos:parseFloat(document.getElementById('kontIznos').value)||0,
    pdv_stopa:parseFloat(document.getElementById('kontPDV').value)||25
  })});
  const el=document.getElementById('kontResult');el.style.display='block';
  el.innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:16px">
      <div class="stat-card"><div class="stat-label">Duguje</div><div class="stat-value">${r.duguje||'?'}</div><small>${r.duguje_naziv||''}</small></div>
      <div class="stat-card"><div class="stat-label">PotraÅ¾uje</div><div class="stat-value">${r.potrazuje||'?'}</div><small>${r.potrazuje_naziv||''}</small></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div class="stat-card"><div class="stat-label">PDV konto</div><div class="stat-value">${r.pdv_konto||'-'}</div></div>
      <div class="stat-card"><div class="stat-label">PDV iznos</div><div class="stat-value">${Number(r.pdv_iznos||0).toFixed(2)} EUR</div></div>
      <div class="stat-card"><div class="stat-label">Pouzdanost</div><div class="stat-value">${Math.round((r.confidence||0)*100)}%</div><small>${r.source||''} ${r.rule_id||''}</small></div>
    </div>
    ${r.napomena?`<div style="margin-top:12px;padding:10px;background:var(--bg);border-radius:8px;color:var(--yellow)">âš ï¸ ${r.napomena}</div>`:''}
    ${r.alternativni&&r.alternativni.length?`<div style="margin-top:12px;color:var(--text2)">Alternativni: ${r.alternativni.map(a=>`${a.duguje}/${a.potrazuje}`).join(', ')}</div>`:''}
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BLAGAJNA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function validateBlagajna(){
  const r=await fetchAPI('/api/blagajna/validate',{method:'POST',body:JSON.stringify({
    iznos:parseFloat(document.getElementById('blagIznos').value)||0,
    tip:document.getElementById('blagTip').value,
    opis:document.getElementById('blagOpis').value,
    partner_oib:document.getElementById('blagOIB').value,
    pocetno_stanje:parseFloat(document.getElementById('blagPocetno').value)||0
  })});
  const el=document.getElementById('blagResult');el.style.display='block';
  const ok=r.valid!==false&&!r.errors?.length;
  el.innerHTML=`<h3>${ok?'âœ… Nalog valjan':'âŒ Problemi pronaÄ‘eni'}</h3><pre>${JSON.stringify(r,null,2)}</pre>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PUTNI NALOZI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function calcPutni(){
  const r=await fetchAPI('/api/putni-nalog/check',{method:'POST',body:JSON.stringify({
    zaposlenik:document.getElementById('pnZaposlenik').value,
    odrediste:document.getElementById('pnOdrediste').value,
    svrha:document.getElementById('pnSvrha').value,
    datum_polaska:document.getElementById('pnDatumOd').value,
    datum_povratka:document.getElementById('pnDatumDo').value,
    km_ukupno:parseFloat(document.getElementById('pnKm').value)||0,
    zemlja:document.getElementById('pnZemlja').value
  })});
  const el=document.getElementById('putniResult');el.style.display='block';
  el.innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
      <div class="stat-card"><div class="stat-label">Dnevnice</div><div class="stat-value">${Number(r.ukupne_dnevnice||r.dnevnice||0).toFixed(2)} EUR</div></div>
      <div class="stat-card"><div class="stat-label">Km naknada</div><div class="stat-value">${Number(r.km_naknada||0).toFixed(2)} EUR</div></div>
      <div class="stat-card"><div class="stat-label">UKUPNO</div><div class="stat-value" style="color:var(--accent2)">${Number(r.ukupno||0).toFixed(2)} EUR</div></div>
    </div>
    ${r.upozorenja?.length?r.upozorenja.map(u=>`<div style="color:var(--yellow)">âš ï¸ ${u}</div>`).join(''):''}
    ${r.greske?.length?r.greske.map(g=>`<div style="color:var(--red)">âŒ ${g}</div>`).join(''):'âœ… Putni nalog ispravan'}
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDV PRIJAVA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function genPDV(){
  const r=await fetchAPI('/api/pdv-prijava/generate',{method:'POST',body:JSON.stringify({
    client_id:document.getElementById('pdvClient')?.value||'',
    mjesec:parseInt(document.getElementById('pdvMjesec').value),
    godina:parseInt(document.getElementById('pdvGodina').value)
  })});
  const el=document.getElementById('pdvResult');el.style.display='block';
  el.innerHTML=`<h3>ğŸ§¾ PP-PDV obrazac</h3><pre>${JSON.stringify(r,null,2)}</pre>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POREZ NA DOBIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function calcPorezDobit(){
  const r=await fetchAPI('/api/porez-dobit/calculate',{method:'POST',body:JSON.stringify({
    prihodi:parseFloat(document.getElementById('pdPrihodi').value)||0,
    rashodi:parseFloat(document.getElementById('pdRashodi').value)||0,
    reprezentacija:parseFloat(document.getElementById('pdReprez').value)||0,
    amortizacija_iznad:parseFloat(document.getElementById('pdAmort').value)||0,
    kazne:parseFloat(document.getElementById('pdKazne').value)||0,
    preneseni_gubitak:parseFloat(document.getElementById('pdGubitak').value)||0
  })});
  const el=document.getElementById('porezResult');el.style.display='block';
  el.innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
      <div class="stat-card"><div class="stat-label">Dobit</div><div class="stat-value">${Number(r.dobit||r.porezna_osnovica||0).toFixed(2)} EUR</div></div>
      <div class="stat-card"><div class="stat-label">Stopa</div><div class="stat-value">${r.stopa||'?'}%</div></div>
      <div class="stat-card"><div class="stat-label">Porez</div><div class="stat-value" style="color:var(--red)">${Number(r.porez_za_uplatu||r.porez||0).toFixed(2)} EUR</div></div>
    </div>
    <pre style="font-size:12px">${JSON.stringify(r,null,2)}</pre>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JOPPD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function genJOPPD(){
  const r=await fetchAPI('/api/joppd/generate-xml',{method:'POST',body:JSON.stringify({
    client_id:document.getElementById('joppdClient')?.value||'',
    mjesec:parseInt(document.getElementById('joppdMjesec').value),
    godina:parseInt(document.getElementById('joppdGodina').value),
    tip:document.getElementById('joppdTip').value
  })});
  const el=document.getElementById('joppdResult');el.style.display='block';
  el.innerHTML=`<h3>ğŸ“„ JOPPD XML</h3><pre>${JSON.stringify(r,null,2)}</pre>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GFI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function genGFI(){
  const r=await fetchAPI('/api/gfi/bilanca',{method:'POST',body:JSON.stringify({
    client_id:document.getElementById('gfiClient')?.value||'',
    godina:parseInt(document.getElementById('gfiGodina').value),
    velicina:document.getElementById('gfiVelicina').value,
    tip:document.getElementById('gfiTip').value
  })});
  const el=document.getElementById('gfiResult');el.style.display='block';
  el.innerHTML=`<h3>ğŸ“Š GFI XML</h3><pre style="max-height:400px;overflow:auto">${typeof r==='string'?r:JSON.stringify(r,null,2)}</pre>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function genIOS(){
  const r=await fetchAPI('/api/ios/generate',{method:'POST',body:JSON.stringify({
    client_id:document.getElementById('iosClient')?.value||'',
    partner_oib:document.getElementById('iosPartnerOIB').value,
    datum_od:document.getElementById('iosDatumOd').value,
    datum_do:document.getElementById('iosDatumDo').value
  })});
  const el=document.getElementById('iosResult');el.style.display='block';
  el.innerHTML=`<h3>ğŸ”„ IOS obrazac</h3><pre>${JSON.stringify(r,null,2)}</pre>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// E-RACUN / PEPPOL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function processEracun(){
  const action=document.getElementById('eracunAction').value;
  if(action==='validate'){
    const file=document.getElementById('eracunFile').files[0];
    if(!file){showToast('Odaberite XML datoteku','error');return}
    const fd=new FormData();fd.append('file',file);
    const r=await fetchAPI('/api/peppol/validate',{method:'POST',body:fd,raw:true});
    document.getElementById('eracunResult').style.display='block';
    document.getElementById('eracunResult').innerHTML=`<h3>Validacija</h3><pre>${JSON.stringify(r,null,2)}</pre>`;
  }else{
    const format=document.getElementById('eracunFormat').value;
    const r=await fetchAPI('/api/e-racun/generate',{method:'POST',body:JSON.stringify({format})});
    document.getElementById('eracunResult').style.display='block';
    document.getElementById('eracunResult').innerHTML=`<h3>E-raÄun (${format})</h3><pre>${typeof r==='string'?r:JSON.stringify(r,null,2)}</pre>`;
  }
}

// Populate client selects on page load
async function loadClientSelects(){
  try{
    const r=await fetchAPI('/api/clients');
    const clients=r.clients||r||[];
    document.querySelectorAll('.client-select').forEach(sel=>{
      sel.innerHTML='<option value="">-- Odaberi klijenta --</option>';
      clients.forEach(c=>{sel.innerHTML+=`<option value="${c.id||c.oib||''}">${c.name||c.naziv||c.id||''}</option>`});
    });
  }catch(e){}
}
</script>
<!-- Keyboard shortcuts hint -->
<div class="kb-hint">âŒ¨ Alt+1 Chat Â· Alt+2 Odobrenja Â· Alt+3 Dashboard Â· Alt+4 PlaÄ‡e Â· Alt+5 Kontiranje Â· Alt+6 Banka Â· Alt+N Fokus</div>
</body>
</html>
